# 第１章 アーキテクチャーについて

## 1.1 アーキテクチャー概要

LIFF-Templateプロジェクトは、クリーンアーキテクチャーの原則に基づいた階層型アーキテクチャーを採用しています。このアーキテクチャーは、関心の分離（Separation of Concerns）を実現し、テスト容易性、保守性、スケーラビリティを向上させるように設計されています。

アプリケーションは以下の主要な層（レイヤー）で構成されています：

1. **クライアント層（Client Layer）**
2. **フック層（Hooks Layer）**
3. **サーバーアクション層（Server Actions Layer）**
4. **サービス層（Service Layer）**
5. **リポジトリ層（Repository Layer）**

これらの層は、それぞれ特定の責任を持ち、明確に定義されたインターフェースを通じて相互に通信します。

## 1.2 各レイヤーの役割と責任

### 1.2.1 クライアント層（Client Layer）

クライアント層は、ユーザーインターフェース（UI）とユーザー体験（UX）を担当します。この層は主にReactコンポーネントで構成されており、以下の責任を持ちます：

- ユーザー入力の処理
- UIの描画とスタイリング
- ユーザーイベントのハンドリング
- クライアントサイドの状態管理

**主要ファイル：**
- `/src/app/page.tsx`：メインページコンポーネント
- `/src/components/features/TodoList/index.tsx`：Todoリスト機能のメインコンポーネント
- `/src/components/LiffProvider.tsx`：LIFF認証のコンテキストプロバイダー

### 1.2.2 フック層（Hooks Layer）

フック層は、React Hooksを使用してロジックをカプセル化し、クライアント層とサーバーアクション層の間の橋渡しをします。この層の主な責任は：

- 再利用可能なロジックのカプセル化
- クライアントサイドの状態管理
- サーバーアクションの呼び出し
- 外部APIとの統合（LIFF SDKなど）

**主要ファイル：**
- `/src/hooks/useLiff.ts`：LIFF SDKとの統合を管理するカスタムフック

### 1.2.3 サーバーアクション層（Server Actions Layer）

サーバーアクション層は、Next.jsのServer Actionsを使用して、クライアントからサーバーサイドの機能を直接呼び出すためのインターフェースを提供します。この層の主な責任は：

- クライアントからのリクエストの処理
- 入力バリデーション
- サービス層の呼び出し
- レスポンスの整形と返却

**主要ファイル：**
- `/src/app/actions.ts`：Todoアイテムの操作に関するサーバーアクション
- `/src/server/handler/actions/login.actions.ts`：認証関連のサーバーアクション

### 1.2.4 サービス層（Service Layer）

サービス層は、ビジネスロジックを実装し、複数のリポジトリを調整する責任を持ちます。この層の主な責任は：

- ビジネスルールの実装
- トランザクション管理
- 複数のリポジトリの調整
- 外部サービスとの統合（OpenAI、Stripe、LINEなど）

**主要ファイル：**
- `/src/server/services/openAiService.ts`：OpenAI APIとの統合
- `/src/server/services/lineAuthService.ts`：LINE認証サービス
- `/src/server/services/supabaseService.ts`：Supabaseサービス
- `/src/server/services/stripeService.ts`：Stripe決済サービス

### 1.2.5 リポジトリ層（Repository Layer）

リポジトリ層は、データアクセスロジックをカプセル化し、データの永続化と取得を担当します。この層の主な責任は：

- データベースとの通信
- データのCRUD操作
- データの変換（データベース形式 ⇔ アプリケーション形式）
- クエリの最適化

**主要ファイル：**
- `/src/repositories/todoRepository.ts`：Todoアイテムのデータアクセス

## 1.3 データフロー

LIFF-Templateアプリケーションにおけるデータフローは、以下のパターンに従います：

1. **ユーザーインタラクション**：ユーザーがUIを通じてアクションを実行（例：Todoの追加）
2. **クライアント層**：ユーザーインタラクションを処理し、必要なデータを収集
3. **フック層**：クライアント層からのデータを受け取り、サーバーアクションを呼び出す
4. **サーバーアクション層**：リクエストを検証し、サービス層に転送
5. **サービス層**：ビジネスロジックを適用し、必要に応じてリポジトリ層を呼び出す
6. **リポジトリ層**：データベースとの通信を行い、結果をサービス層に返す
7. **サービス層→サーバーアクション層→フック層→クライアント層**：結果が逆方向に伝播
8. **UI更新**：クライアント層がUIを更新して結果をユーザーに表示

## 1.4 認証フロー

LIFF-Templateアプリケーションの認証フローは、LINE LIFFを使用して実装されています：

1. **LIFF初期化**：`LiffProvider`コンポーネントがアプリケーション起動時にLIFF SDKを初期化
2. **ユーザーログイン**：ユーザーがLINEアカウントでログイン
3. **トークン検証**：`lineAuthService`がLINEトークンを検証
4. **プロフィール取得**：認証成功後、ユーザープロフィールを取得
5. **セッション管理**：ユーザーIDをクッキーに保存し、セッションを維持
6. **認証状態の提供**：`useLiff`フックが認証状態をアプリケーション全体に提供

## 1.5 プロジェクトのファイル構造

LIFF-Templateプロジェクトのファイル構造は、機能とレイヤーに基づいて整理されています：

```
/src
  /app                   # Next.jsアプリケーションルートとレイアウト
    /actions.ts          # Todoのサーバーアクション
    /globals.css         # グローバルスタイルとTailwind設定
    /layout.tsx          # ルートレイアウトコンポーネント
    /page.tsx            # ホームページコンポーネント（エントリーポイント）
  
  /components            # UIコンポーネント
    /LiffProvider.tsx    # LIFFコンテキストプロバイダー
    /features            # 機能別コンポーネント
      /TodoList/         # Todoリスト機能のコンポーネント
  
  /hooks                 # カスタムReact Hooks
    /useLiff.ts          # LIFF機能のカスタムフック
  
  /repositories          # データアクセス層
    /todoRepository.ts   # Todoのデータアクセス
  
  /server                # サーバーサイドコード
    /handler             # リクエストハンドラー
      /actions           # サーバーアクション
        /login.actions.ts # ログイン関連のアクション
    /services            # サービス層
      /lineAuthService.ts # LINE認証サービス
      /openAiService.ts  # OpenAI APIサービス
      /stripeService.ts  # Stripe決済サービス
      /supabaseService.ts # Supabaseサービス
  
  /types                 # 型定義
    /todo.ts             # Todoアイテムの型定義
  
  /env.ts                # 環境変数の型安全な定義

/supabase               # Supabase関連ファイル
  /migrations           # データベースマイグレーション
```

## 1.6 アーキテクチャーの利点

LIFF-Templateプロジェクトで採用されているアーキテクチャーには、以下の利点があります：

### 1.6.1 関心の分離

各レイヤーが明確に定義された責任を持つことで、コードの理解と保守が容易になります。例えば、UIの変更がビジネスロジックやデータアクセスに影響を与えることはありません。

### 1.6.2 テスト容易性

レイヤー間の依存関係が明確に定義されているため、各レイヤーを独立してテストすることが可能です。モックやスタブを使用して、依存関係を分離したテストが書きやすくなります。

### 1.6.3 スケーラビリティ

新機能の追加や既存機能の拡張が容易になります。例えば、新しいデータソースを追加する場合、リポジトリ層に新しいリポジトリを追加するだけで、他のレイヤーへの影響を最小限に抑えることができます。

### 1.6.4 技術的柔軟性

特定のレイヤーの実装を変更しても、インターフェースが維持されていれば、他のレイヤーへの影響は最小限に抑えられます。例えば、データベースをSupabaseから別のサービスに変更する場合、リポジトリ層の実装のみを変更すれば良いです。

### 1.6.5 チーム開発の効率化

明確に定義されたレイヤーとインターフェースにより、複数の開発者が並行して作業することが容易になります。各開発者が特定のレイヤーやコンポーネントに集中することができます。

## 1.7 まとめ

LIFF-Templateプロジェクトのアーキテクチャーは、クリーンアーキテクチャーの原則に基づいた階層型アーキテクチャーを採用しています。クライアント層、フック層、サーバーアクション層、サービス層、リポジトリ層の5つの主要なレイヤーで構成され、それぞれが明確に定義された責任を持ちます。

このアーキテクチャーにより、関心の分離、テスト容易性、スケーラビリティ、技術的柔軟性、チーム開発の効率化などの利点が得られます。また、LINE LIFF、Supabase、OpenAI、Stripeなどの外部サービスとの統合も、このアーキテクチャーの中で整理されています。

LIFF-Templateプロジェクトを拡張または修正する際は、このアーキテクチャーの原則を理解し、適切なレイヤーに変更を加えることが重要です。
