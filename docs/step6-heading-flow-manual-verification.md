# Step6/Step7 見出し単位生成フロー 動作確認手順

## 1. 前提条件

- ローカル環境で `npm run dev` が起動していること
- LIFF認証済みでチャット画面にアクセスできること
- ブログ作成モデル（`blog_creation`）が選択可能なこと

---

## 2. 動作確認手順

### 2.1 Step1〜Step5 の到達（構成案確定）

1. チャット画面で「ブログ作成」モデルを選択
2. 新規セッションで Step1 から開始
3. 各ステップで以下を入力して送信し、Step5 まで進む:
   - **Step1**: `顕在ニーズはクリーニング料金の明朗化、潜在ニーズは安心感です`
   - **Step2**: `40代主婦、自宅エアコンのクリーニングを検討している層`
   - **Step3**: `エアコンクリーニングの相場を知り、信頼できる業者を選びたい`
   - **Step4**: `PREP構成で、主張→理由→具体例→結論の流れで`
4. **Step5** で以下の**テスト用構成案**を入力欄に貼り付けて送信する:

```
以下の構成案で確定します。

# エアコンクリーニング完全ガイド
## はじめに
本記事では、エアコンクリーニングの必要性と業者選びのポイントを解説します。

### エアコンクリーニングとは
定期的なクリーニングの定義と重要性。

### クリーニングの効果
#### 冷暖房効率の改善
電気代削減の観点。

### 業者選びのポイント
価格比較、実績、口コミの見方。
```

5. AI が上記を反映した返答を返す（`model=blog_creation_step5`）ことを確認
6. 画面の「スキップ」ボタンで **Step6** に遷移

---

### 2.2 Step6 初回入場の確認

7. Step6 に入ると以下を確認:
   - **初期化中のローディング**が表示される（見出し抽出〜DB投入）
   - 数秒後、**現在の見出し: 1/4「エアコンクリーニングとは」** が StepActionBar に表示される
   - Canvas に **「1件目の生成をスタート」** ボタンが表示される（チャット入力不要）

8. **見出し0件のケース**: Step5 に `###` / `####` を含まないテキストのみを送った場合、「見出しが見つかりません。Step5を見直してください」が表示されること

9. **h1/h2 の除外確認**: 構成案に含めた `#` (h1)「エアコンクリーニング完全ガイド」と `##` (h2)「はじめに」は Step6 に見出しとして取り込まれないこと。見出し抽出は H3/H4 のみ対象のため、1/4 は「エアコンクリーニングとは」から開始する

---

### 2.3 見出し1件目の生成・保存

10. **「1件目の生成をスタート」** ボタンをクリック（チャットに入力せずに生成開始）
11. AI が生成中であること、**ローディング表示とボタン無効化**を確認
12. 生成完了後、Canvas に本文が表示され、**「保存して次の見出しへ」** ボタンに切り替わる
13. 必要に応じて Canvas 上で文言を修正
14. **「保存して次の見出しへ」** をクリック
15. **保存中のローディング**がボタンに表示され、二重クリックが防がれることを確認
16. 保存成功後、**現在の見出し: 2/4「クリーニングの効果」** に進むこと
17. Canvas が空になる（次の見出しのためクリアされる）

---

### 2.4 見出し2〜4 の繰り返し

18. 見出し2〜4 についても同様に:
    - **「この見出しを生成」** ボタンをクリック（または入力欄から指示を送信）
    - Canvas で確認・修正
    - **「保存して次の見出しへ」** で確定
19. 最後の見出し（4件目）では、ボタンが **「保存して全構成を確認」** と表示されること

---

### 2.5 最終見出し保存後の確認

20. 最後の見出しを保存すると:
    - トーストで「全見出しの保存が完了しました…」が表示される
    - Canvas に **全見出し分を結合した完成形** が表示される
    - StepActionBar の見出し表示は消える（`activeHeading` が無い状態）

---

### 2.6 「戻る」操作の確認

21. 見出し3 の表示中に **「バック」** をクリック
22. 未保存の編集がある場合、確認ダイアログが表示されること
23. 前の見出し（見出し2）に戻り、確定済み本文が表示されること

---

### 2.7 全文 Canvas 修正（Step6 完了後）

24. 全見出し保存後、Canvas の完成形を編集
25. 編集指示（選択範囲＋改善指示）で Canvas ストリームを実行
26. 編集結果が `session_combined_contents` に新バージョンとして保存されること（内部動作）
27. Canvas に編集後テキストが表示されること

---

### 2.8 Step7 への遷移と入力確認

28. 入力欄でメッセージを送信し、**Step7** に遷移
29. Step7 実行時、**最新完成形**（Step6 の結合＋全文修正）が AI への入力として渡されること
30. Step7 で最終本文が生成されること

---

### 2.9 エラー表示の確認（任意）

31. ネットワークをオフにするか、一時的に API を遮断
32. 「保存して次へ」をクリック
33. **ボタン近傍にエラーメッセージ**が表示され、再試行できること

---

## 3. テスト用データ一覧

### 3.1 Step5 用 構成案テキスト（最小ケース：5見出し）

```
以下の構成案で確定します。

### はじめに
エアコンクリーニングブログの目的と読み手への約束。

### 本論
#### メリット
エアコンクリーニングを依頼する理由。
#### デメリットと対策
想定される懸念点への対応。

### まとめ
行動を促す締めのメッセージ。
```

→ 抽出される見出し: 5件（はじめに / 本論 / メリット / デメリットと対策 / まとめ）

---

### 3.2 Step5 用 構成案テキスト（標準ケース：6見出し）

上記「2.1 Step5」で使用したエアコンクリーニングの構成案を使用。→ 抽出される見出し: 4件

---

### 3.3 Step5 用 構成案テキスト（H3/H4 混在・8見出し）

```
以下の構成案で確定します。

### エアコンクリーニングのメリット
定期的なクリーニングの効果を簡潔に。

### 業者が行う3つの作業
#### 作業1：フィルター清掃
汚れの除去と目詰まり解消。
#### 作業2：内部洗浄
熱交換器やドレンホースの洗浄。
#### 作業3：除菌消臭
カビ対策と清潔な空気環境。

### お客様の声
導入事例を2件紹介。

### よくある質問
#### 料金の相場は？
#### 季節のいつ頃がおすすめ？
```

→ 抽出される見出し: 8件

---

### 3.4 非対象パターン（抽出されないことの確認用）

以下は **見出しとして抽出されない** ことを確認:

- `#` (H1) … 対象外
- `##` (H2) … 対象外
- `#####` (H5), `######` (H6) … 対象外
- `- 箇条書き` … 対象外

---

## 4. 想定される問題と対処

| 現象 | 想定原因 | 対処 |
|------|----------|------|
| 見出しが見つかりません | Step5 に `###`/`####` なし | Step5 の構成案に H3/H4 を追加 |
| 初期化が終わらない | session_id 不整合、RLS | 認証・セッションを確認 |
| 保存に失敗しました | DB エラー、ネットワーク | コンソール・ネットワークタブを確認 |
| 完成形が表示されない | `session_combined_contents` 未生成 | 全見出しを保存し直す |
| Step7 で「最新完成形を取得できません」 | Step6 未完了 or 結合データなし | Step6 を最後まで完了させる |

---

## 5. DB 直接投入で Step5 をスキップする場合（任意）

AI を経由せず Step6 から検証したい場合、既存セッションに Step5 相当のメッセージを投入する。

**注意**: `session_id` と `user_id` は実際の値に置き換えること。

```sql
-- 1. 対象セッションの user_id を確認
SELECT id, user_id FROM chat_sessions WHERE id = 'あなたのsession_id';

-- 2. Step5 構成案メッセージを投入
INSERT INTO chat_messages (
  id, user_id, session_id, role, content, model, created_at
) VALUES (
  gen_random_uuid(),
  '上記で確認したuser_id',
  'あなたのsession_id',
  'assistant',
  E'以下の構成案で確定します。\n\n### エアコンクリーニングとは\n定期的なクリーニングの定義と重要性。\n\n### クリーニングの効果\n#### 冷暖房効率の改善\n電気代削減の観点。\n#### 健康への配慮\nホコリやカビ対策。\n\n### クリーニングのタイミング\n春・秋のメンテナンス時期。\n\n### 業者選びのポイント\n価格比較、実績、口コミの見方。',
  'blog_creation_step5',
  NOW()
);
```

投入後、該当セッションを開き「スキップ」で Step6 まで進める。
