# è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²æ©Ÿèƒ½ è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2026-01-06
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æ‰¿èªæ¸ˆã¿

---

## æ¦‚è¦

äº‹æ¥­è€…æƒ…å ±ï¼ˆ5W2Hï¼‰ã‚’è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç™»éŒ²ã§ãã‚‹ã‚ˆã†ã«ã—ã€ãƒãƒ£ãƒƒãƒˆç”»é¢ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ä½¿ã„åˆ†ã‘ã‚‰ã‚Œã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã€‚

### è¦ä»¶ã‚µãƒãƒª

| é …ç›® | ä»•æ§˜ |
|-----|------|
| ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ãƒšãƒ«ã‚½ãƒŠ | å…¨ã‚µãƒ¼ãƒ“ã‚¹å…±é€š |
| 5W2H | ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç‹¬ç«‹ |
| ã‚µãƒ¼ãƒ“ã‚¹å | å¿…é ˆï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ |
| ãƒãƒ£ãƒƒãƒˆã§ã®ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ | ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§å›ºå®š |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ | æœ€åˆã«ç™»éŒ²ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ |
| æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ | è‡ªå‹•ã§ã€Œã‚µãƒ¼ãƒ“ã‚¹1ã€ã¨ã—ã¦ç§»è¡Œ |

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³1: ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ç¾çŠ¶ â†’ å¤‰æ›´å¾Œ

```
ã€ç¾çŠ¶ã€‘briefs ãƒ†ãƒ¼ãƒ–ãƒ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id (UNIQUE)                    â”‚
â”‚ data: { profile, persona, 5W2H }    â”‚  â† å…¨ã¦ãƒ•ãƒ©ãƒƒãƒˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å¤‰æ›´å¾Œã€‘briefs ãƒ†ãƒ¼ãƒ–ãƒ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id (UNIQUE)                                    â”‚
â”‚ data: {                                             â”‚
â”‚   profile: { company, address, ceo, ... },          â”‚  â† å…±é€š
â”‚   persona: { ... },                                 â”‚  â† å…±é€š
â”‚   services: [                                       â”‚  â† é…åˆ—åŒ–
â”‚     { id, name, strength, when, where, ... },       â”‚
â”‚     { id, name, strength, when, where, ... },       â”‚
â”‚   ]                                                 â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### chat_sessions ãƒ†ãƒ¼ãƒ–ãƒ«å¤‰æ›´

```sql
ALTER TABLE chat_sessions ADD COLUMN service_id TEXT;
-- æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç§»è¡Œæ™‚ã«æœ€åˆã®ã‚µãƒ¼ãƒ“ã‚¹IDã‚’è¨­å®š
```

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³2: Zodã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´

### brief.schema.ts

```typescript
// 5W2Hï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ï¼‰
export const serviceSchema = z.object({
  id: z.string().uuid(),
  name: z.string().min(1, 'ã‚µãƒ¼ãƒ“ã‚¹åã¯å¿…é ˆã§ã™'),  // å¿…é ˆ
  strength: z.string().optional(),
  when: z.string().optional(),
  where: z.string().optional(),
  who: z.string().optional(),
  why: z.string().optional(),
  what: z.string().optional(),
  how: z.string().optional(),
  price: z.string().optional(),
});

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆå…±é€šï¼‰
export const profileSchema = z.object({
  company: z.string().optional(),
  address: z.string().optional(),
  ceo: z.string().optional(),
  hobby: z.string().optional(),
  staff: z.string().optional(),
  staffHobby: z.string().optional(),
  businessHours: z.string().optional(),
  holiday: z.string().optional(),
  tel: z.string().optional(),
  license: z.string().optional(),
  qualification: z.string().optional(),
  capital: z.string().optional(),
  email: createOptionalEmailValidator(),
  payments: z.array(paymentEnum).optional(),
  benchmarkUrl: createOptionalUrlValidator(),
  competitorCopy: z.string().optional(),
});

// å…¨ä½“æ§‹é€ 
export const briefInputSchema = z.object({
  profile: profileSchema,
  persona: z.string().optional(),
  services: z.array(serviceSchema).min(1, 'æœ€ä½1ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¿…è¦ã§ã™'),
});

// å‹å®šç¾©
export type Service = z.infer<typeof serviceSchema>;
export type Profile = z.infer<typeof profileSchema>;
export type BriefInput = z.infer<typeof briefInputSchema>;
```

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³3: äº‹æ¥­è€…æƒ…å ±ç”»é¢ UI

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äº‹æ¥­è€…æƒ…å ±                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‹ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ï¼ˆå…±é€šï¼‰                    â”‚   â”‚
â”‚  â”‚ [ä¼šç¤¾å] [æ‰€åœ¨åœ°] [ä»£è¡¨è€…å] ...              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‘¤ ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ï¼ˆå…±é€šï¼‰                       â”‚   â”‚
â”‚  â”‚ [ãƒšãƒ«ã‚½ãƒŠ]                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ·ï¸ ã‚µãƒ¼ãƒ“ã‚¹1: ã‚¨ã‚¢ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°    [ğŸ—‘ï¸]  â”‚   â”‚
â”‚  â”‚ [ã‚µãƒ¼ãƒ“ã‚¹å*] â† å¿…é ˆ                         â”‚   â”‚
â”‚  â”‚ [å¼·ã¿] [ã„ã¤] [ã©ã“ã§] [èª°ãŒ] ...            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ·ï¸ ã‚µãƒ¼ãƒ“ã‚¹2: æ°´å›ã‚Šã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°      [ğŸ—‘ï¸]  â”‚   â”‚
â”‚  â”‚ [ã‚µãƒ¼ãƒ“ã‚¹å*] â† å¿…é ˆ                         â”‚   â”‚
â”‚  â”‚ [å¼·ã¿] [ã„ã¤] [ã©ã“ã§] [èª°ãŒ] ...            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â”‚            [ï¼‹ ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ]                       â”‚
â”‚                                                     â”‚
â”‚              [äº‹æ¥­è€…æƒ…å ±ã‚’ä¿å­˜]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ“ä½œä»•æ§˜

| æ“ä½œ | å‹•ä½œ |
|-----|------|
| **ï¼‹ãƒœã‚¿ãƒ³** | ç©ºã®ã‚µãƒ¼ãƒ“ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’æœ«å°¾ã«è¿½åŠ  |
| **ğŸ—‘ï¸ãƒœã‚¿ãƒ³** | ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¾Œã«ã‚«ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆæœ€å¾Œã®1ã¤ã¯å‰Šé™¤ä¸å¯ï¼‰ |
| **ä¿å­˜** | å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³4: ãƒãƒ£ãƒƒãƒˆç”»é¢ UI

### ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚µã‚¤ãƒ‰ãƒãƒ¼           â”‚  ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                 â”‚
â”‚ â”‚ ğŸ·ï¸ ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ   â”‚ â”‚  â€»ã‚µãƒ¼ãƒ“ã‚¹ãŒ2ã¤ä»¥ä¸Šã®æ™‚ã®ã¿è¡¨ç¤º  â”‚
â”‚ â”‚ [â–¼ ã‚¨ã‚¢ã‚³ãƒ³... ] â”‚ â”‚                                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚  ï¼‹ æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ    â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚  ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§    â”‚  ï¼ˆé¸æŠä¸­ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿è¡¨ç¤ºï¼‰       â”‚
â”‚  â”œâ”€ ã‚¨ã‚¢ã‚³ãƒ³è¦‹ç©LP   â”‚                                 â”‚
â”‚  â”œâ”€ å¤ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³åºƒå‘Šâ”‚                                 â”‚
â”‚  â””â”€ ãƒ–ãƒ­ã‚°è¨˜äº‹æ¡ˆ     â”‚                                 â”‚
â”‚                      â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‹•ä½œä»•æ§˜

| æ¡ä»¶ | è¡¨ç¤º |
|-----|------|
| **ã‚µãƒ¼ãƒ“ã‚¹1ã¤** | ã‚µãƒ¼ãƒ“ã‚¹é¸æŠUIéè¡¨ç¤ºã€å¾“æ¥é€šã‚Š |
| **ã‚µãƒ¼ãƒ“ã‚¹2ã¤ä»¥ä¸Š** | ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º |

| æ“ä½œ | å‹•ä½œ |
|-----|------|
| **ã‚µãƒ¼ãƒ“ã‚¹åˆ‡æ›¿** | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’é¸æŠã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° |
| **æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ** | ç¾åœ¨é¸æŠä¸­ã®ã‚µãƒ¼ãƒ“ã‚¹ã§æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ** | ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹ãï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã¯å›ºå®šæ¸ˆã¿ï¼‰ |

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ•ãƒ­ãƒ¼

```
ã‚µãƒ¼ãƒ“ã‚¹é¸æŠä¸­ â†’ ã€Œæ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã€ã‚¯ãƒªãƒƒã‚¯
    â†“
æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆservice_id = é¸æŠä¸­ã‚µãƒ¼ãƒ“ã‚¹IDï¼‰
    â†“
getSystemPrompt() ã§é¸æŠã‚µãƒ¼ãƒ“ã‚¹ã®5W2Hã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«åŸ‹ã‚è¾¼ã¿
    â†“
ãƒãƒ£ãƒƒãƒˆé–‹å§‹
```

### æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆservice_id ãŒ NULLï¼‰ã¯ã€æœ€åˆã®ã‚µãƒ¼ãƒ“ã‚¹ã«è‡ªå‹•ç´ã¥ã‘ã€‚

```sql
UPDATE chat_sessions
SET service_id = (
  SELECT (briefs.data->'services'->0->>'id')
  FROM briefs
  WHERE briefs.user_id = chat_sessions.user_id
)
WHERE service_id IS NULL;
```

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³5: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ•°ç½®æ›ã®å¤‰æ›´

### ç¾çŠ¶ã®æµã‚Œ

```
getCachedBrief(token) â†’ BriefInputï¼ˆãƒ•ãƒ©ãƒƒãƒˆï¼‰
    â†“
replaceTemplateVariables(template, businessInfo)
    â†“
{{strength}}, {{when}}, {{where}} ... ã‚’ç½®æ›
```

### å¤‰æ›´å¾Œã®æµã‚Œ

```
getCachedBrief(token) â†’ BriefInputï¼ˆæ–°æ§‹é€ ï¼‰
    â†“
getServiceById(services, serviceId) â†’ Service
    â†“
replaceTemplateVariables(template, { ...profile, ...service })
    â†“
{{strength}}, {{when}}, {{where}} ... ã‚’ç½®æ›ï¼ˆå¤‰æ›´ãªã—ï¼‰
```

### getSystemPrompt ã®å¤‰æ›´

```typescript
// ç¾çŠ¶
export async function getSystemPrompt(
  model: string,
  liffAccessToken: string,
  sessionId?: string
): Promise<string>

// å¤‰æ›´å¾Œ
export async function getSystemPrompt(
  model: string,
  liffAccessToken: string,
  sessionId?: string,
  serviceId?: string  // è¿½åŠ ï¼šæ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚ã«æ¸¡ã™
): Promise<string>
```

- **æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³**: sessionId ã‹ã‚‰ service_id ã‚’å–å¾—
- **æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³**: å¼•æ•°ã® serviceId ã‚’ä½¿ç”¨

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³6: ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯

```typescript
// æ—§å½¢å¼ â†’ æ–°å½¢å¼ã¸ã®å¤‰æ›
function migrateOldBriefToNew(oldData: OldBriefInput): NewBriefInput {
  return {
    profile: {
      company: oldData.company,
      address: oldData.address,
      ceo: oldData.ceo,
      hobby: oldData.hobby,
      staff: oldData.staff,
      staffHobby: oldData.staffHobby,
      businessHours: oldData.businessHours,
      holiday: oldData.holiday,
      tel: oldData.tel,
      license: oldData.license,
      qualification: oldData.qualification,
      capital: oldData.capital,
      email: oldData.email,
      payments: oldData.payments,
      benchmarkUrl: oldData.benchmarkUrl,
      competitorCopy: oldData.competitorCopy,
    },
    persona: oldData.persona,
    services: [
      {
        id: crypto.randomUUID(),
        name: oldData.service || 'ã‚µãƒ¼ãƒ“ã‚¹1',
        strength: oldData.strength,
        when: oldData.when,
        where: oldData.where,
        who: oldData.who,
        why: oldData.why,
        what: oldData.what,
        how: oldData.how,
        price: oldData.price,
      }
    ],
  };
}
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥: é…å»¶ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ™‚ã«æ—§å½¢å¼ã‚’æ¤œå‡ºã—ãŸã‚‰æ–°å½¢å¼ã«å¤‰æ›ã—ã¦è¿”ã™ã€‚ä¿å­˜æ™‚ã«æ–°å½¢å¼ã§ä¸Šæ›¸ãã€‚

```typescript
// BriefService.getByUserId å†…ã§
const rawData = data.data;

// æ—§å½¢å¼åˆ¤å®šï¼šservicesã‚­ãƒ¼ãŒãªã‘ã‚Œã°æ—§å½¢å¼
if (!rawData.services) {
  return migrateOldBriefToNew(rawData);
}
return rawData;
```

**ãƒ¡ãƒªãƒƒãƒˆ**: DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸è¦ã€æ®µéšçš„ã«ç§»è¡Œã•ã‚Œã‚‹

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³7: å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

| ã‚«ãƒ†ã‚´ãƒª | ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|---------|---------|---------|
| **Schema** | `src/server/schemas/brief.schema.ts` | serviceSchema, æ–°briefInputSchemaè¿½åŠ  |
| **Service** | `src/server/services/briefService.ts` | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ  |
| **Service** | `src/server/services/supabaseService.ts` | getSessionServiceIdè¿½åŠ  |
| **Prompts** | `src/lib/prompts.ts` | getSystemPromptã«serviceIdå¼•æ•°è¿½åŠ  |
| **Actions** | `src/server/actions/brief.actions.ts` | æ–°å½¢å¼å¯¾å¿œ |
| **UI** | `app/business-info/components/BusinessInfoFormClient.tsx` | ã‚«ãƒ¼ãƒ‰å½¢å¼UIã€ï¼‹/ğŸ—‘ï¸ãƒœã‚¿ãƒ³ |
| **UI** | `app/chat/components/SessionSidebar.tsx` | ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¿½åŠ  |
| **UI** | `app/chat/components/ChatLayout.tsx` | ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç®¡ç†è¿½åŠ  |
| **Hook** | `src/hooks/useChatSession.ts` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚serviceIdé€ä¿¡ |
| **API** | `app/api/chat/anthropic/stream/route.ts` | serviceIdå—ã‘å–ã‚Šå¯¾å¿œ |
| **DB** | `supabase/migrations/YYYYMMDD_add_service_id_to_sessions.sql` | service_idåˆ—è¿½åŠ  |

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|---------|------|
| `app/business-info/components/ServiceCard.tsx` | ã‚µãƒ¼ãƒ“ã‚¹å…¥åŠ›ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| `app/chat/components/ServiceSelector.tsx` | ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ |

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³8: å®Ÿè£…é †åº

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤ï¼ˆãƒ‡ãƒ¼ã‚¿å±¤ï¼‰
1. `brief.schema.ts` - æ–°ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
2. `briefService.ts` - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
3. `brief.actions.ts` - æ–°å½¢å¼å¯¾å¿œ
4. `supabaseService.ts` - getSessionServiceIdè¿½åŠ 

### ãƒ•ã‚§ãƒ¼ã‚º2: DB
5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQL - chat_sessionsã«service_idåˆ—è¿½åŠ 

### ãƒ•ã‚§ãƒ¼ã‚º3: äº‹æ¥­è€…æƒ…å ±ç”»é¢
6. `ServiceCard.tsx` - æ–°è¦ä½œæˆ
7. `BusinessInfoFormClient.tsx` - ã‚«ãƒ¼ãƒ‰UIå®Ÿè£…

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
8. `prompts.ts` - getSystemPromptæ”¹ä¿®
9. `stream/route.ts` - serviceIdå—ã‘å–ã‚Š

### ãƒ•ã‚§ãƒ¼ã‚º5: ãƒãƒ£ãƒƒãƒˆç”»é¢
10. `ServiceSelector.tsx` - æ–°è¦ä½œæˆ
11. `SessionSidebar.tsx` - ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼çµ„ã¿è¾¼ã¿
12. `ChatLayout.tsx` - ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç®¡ç†
13. `useChatSession.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚serviceIdé€ä¿¡

### ãƒ•ã‚§ãƒ¼ã‚º6: æ¤œè¨¼
14. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã§ã®å‹•ä½œç¢ºèª
15. æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ â†’ãƒãƒ£ãƒƒãƒˆâ†’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¢ºèª

---

## ã‚»ã‚¯ã‚·ãƒ§ãƒ³9: ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»è¿½åŠ ä»•æ§˜

### ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤æ™‚ã®å‡¦ç†

| çŠ¶æ³ | å‹•ä½œ |
|-----|------|
| ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤ | ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º |
| ç´ã¥ãã‚»ãƒƒã‚·ãƒ§ãƒ³ | `service_id = NULL` ã«æ›´æ–°ï¼ˆæœªåˆ†é¡æ‰±ã„ï¼‰ |
| æœªåˆ†é¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¡¨ç¤º | ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ã‚‚å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ |

```typescript
// ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
async function deleteService(userId: string, serviceId: string) {
  // 1. ç´ã¥ãã‚»ãƒƒã‚·ãƒ§ãƒ³ã® service_id ã‚’ NULL ã«
  await supabase
    .from('chat_sessions')
    .update({ service_id: null })
    .eq('user_id', userId)
    .eq('service_id', serviceId);

  // 2. ã‚µãƒ¼ãƒ“ã‚¹ã‚’é…åˆ—ã‹ã‚‰å‰Šé™¤ã—ã¦ä¿å­˜
  // ...
}
```

### ã‚µãƒ¼ãƒ“ã‚¹æ•°ã®ä¸Šé™

- **ä¸Šé™ãªã—**ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¥­æ…‹ã«å¿œã˜ã¦è‡ªç”±ã«è¿½åŠ å¯èƒ½ï¼‰

### ã‚µãƒ¼ãƒ“ã‚¹IDç”Ÿæˆ

- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ç”Ÿæˆ**ï¼ˆ`crypto.randomUUID()`ï¼‰
- ä¿å­˜æ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ï¼ˆUUIDã®è¡çªç¢ºç‡ã¯ç„¡è¦–ã§ãã‚‹ï¼‰

### ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º

| çŠ¶æ³ | å‹•ä½œ |
|-----|------|
| ã‚µã‚¤ãƒ‰ãƒãƒ¼Sheetè¡¨ç¤ºæ™‚ | Sheetå†…ä¸Šéƒ¨ã«ã‚µãƒ¼ãƒ“ã‚¹é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º |
| ã‚µãƒ¼ãƒ“ã‚¹åˆ‡æ›¿ | Sheetã‚’é–‰ã˜ãšã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æ›´æ–° |

### ä»–APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¯¾å¿œ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | serviceIdå¯¾å¿œ | ç†ç”± |
|--------------|--------------|------|
| `/api/chat/anthropic/stream` | **å¿…è¦** | getSystemPromptã§5W2Hä½¿ç”¨ |
| `/api/chat/canvas/stream` | ä¸è¦ | getSystemPromptæœªä½¿ç”¨ |
| `/api/chat/canvas/load-wordpress` | ä¸è¦ | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãªã— |

---

## æ±ºå®šäº‹é …ã¾ã¨ã‚

| è³ªå• | æ±ºå®š |
|-----|------|
| ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ãƒšãƒ«ã‚½ãƒŠã®æ‰±ã„ | å…¨ã‚µãƒ¼ãƒ“ã‚¹å…±é€š |
| ãƒãƒ£ãƒƒãƒˆã§ã®ã‚µãƒ¼ãƒ“ã‚¹é¸æŠç¯„å›² | ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§å›ºå®š |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒ“ã‚¹ | æœ€åˆã«ç™»éŒ²ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ |
| æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ | è‡ªå‹•ã§ã€Œã‚µãƒ¼ãƒ“ã‚¹1ã€ã¨ã—ã¦ç§»è¡Œ |
| ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ | system_promptã«åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼ˆè¿½åŠ ä¿å­˜ä¸è¦ï¼‰ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³çµã‚Šè¾¼ã¿ | chat_sessionsã«service_idåˆ—è¿½åŠ  |
| æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ‰±ã„ | æœ€åˆã®ã‚µãƒ¼ãƒ“ã‚¹ã«è‡ªå‹•ç´ã¥ã‘ |
| ã‚µãƒ¼ãƒ“ã‚¹é¸æŠUIé…ç½® | ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸Šéƒ¨ |
| ã‚µãƒ¼ãƒ“ã‚¹1ã¤ã®å ´åˆ | é¸æŠUIéè¡¨ç¤ºã€å¾“æ¥é€šã‚Š |
| ã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ | service_id ã‚’ NULL ã«ã—ã¦æœªåˆ†é¡æ‰±ã„ |
| ã‚µãƒ¼ãƒ“ã‚¹æ•°ã®ä¸Šé™ | ä¸Šé™ãªã— |
| ã‚µãƒ¼ãƒ“ã‚¹IDç”Ÿæˆ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ crypto.randomUUID() |
