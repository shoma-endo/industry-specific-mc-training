# ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆMagic Linkï¼‰& LINEâ†’Email ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œ ä»•æ§˜æ›¸

**ä½œæˆæ—¥**: 2026-03-01
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ãƒ‰ãƒ©ãƒ•ãƒˆ

---

## 1. ç›®çš„ãƒ»èƒŒæ™¯

### 1.1 ç›®çš„

ç¾è¡Œã® LINE LIFF èªè¨¼ã«åŠ ãˆã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹ Magic Link èªè¨¼ã‚’å°å…¥ã™ã‚‹ã€‚
ã¾ãŸã€æ—¢å­˜ã® LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ç§»è¡Œã§ãã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã€LINE ã«ä¾å­˜ã—ãªã„ãƒ­ã‚°ã‚¤ãƒ³æ‰‹æ®µã‚’ç¢ºç«‹ã™ã‚‹ã€‚

### 1.2 èƒŒæ™¯

- LINE LIFF ã«ä¾å­˜ã—ãŸèªè¨¼ã¯ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶ç´„ã‚„ LINE ã‚¢ãƒ—ãƒªæœªå°å…¥ç’°å¢ƒã§éšœå£ã¨ãªã‚‹
- B2B SaaS ã¨ã—ã¦ãƒ¡ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ã¯é¡§å®¢ã®æœŸå¾…å€¤ã«åˆè‡´ã™ã‚‹
- å°†æ¥çš„ãªãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆaccount_idï¼‰ç®¡ç†ã®å‰æåŸºç›¤ã¨ã—ã¦ã€èªè¨¼æ‰‹æ®µã®æŸ”è»ŸåŒ–ãŒå¿…è¦

---

## 2. ã‚¹ã‚³ãƒ¼ãƒ—

### å¯¾è±¡

- **Phase 1**: Magic Link ã«ã‚ˆã‚‹ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
- **Phase 1.5**: æ—¢å­˜ LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ©Ÿèƒ½ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä»»æ„ï¼‰

### éå¯¾è±¡

- Phase 2 ä»¥é™ã®ãƒãƒ«ãƒãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ï¼ˆ`account_id` å°å…¥ï¼‰
- Phase 3: Stripe å»ƒæ­¢
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼ˆMagic Link ã®ã¿ï¼‰
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆGoogle, GitHub ç­‰ï¼‰ã®è¿½åŠ 
- LINE èªè¨¼ã®å»ƒæ­¢ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«ä½µå­˜ã‚’ç¶­æŒï¼‰

---

## 3. ç”¨èªå®šç¾©

| ç”¨èª | å®šç¾© |
|------|------|
| Magic Link | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã•ã‚Œã‚‹ä¸€å›é™ã‚Šã®èªè¨¼ãƒªãƒ³ã‚¯ã€‚ã‚¯ãƒªãƒƒã‚¯ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã™ã‚‹ |
| èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ (`auth_provider`) | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼æ‰‹æ®µã‚’ç¤ºã™è­˜åˆ¥å­ã€‚`line` ã¾ãŸã¯ `email` |
| ç§»è¡Œå…ƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | LINE èªè¨¼ã§ä½œæˆã•ã‚ŒãŸæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ |
| ç§»è¡Œå…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | Magic Link ã§ä½œæˆã•ã‚ŒãŸæ–°è¦ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ |
| ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçµ±åˆ | ç§»è¡Œå…ƒã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œå…ˆã«ç´ä»˜ã‘ç›´ã—ã€ç§»è¡Œå…ƒã‚’ç„¡åŠ¹åŒ–ã™ã‚‹æ“ä½œ |

---

## 4. å‰ææ¡ä»¶

### 4.1 ç¾è¡Œèªè¨¼ãƒ•ãƒ­ãƒ¼

```
LINE ã‚¢ãƒ—ãƒª
  â†’ LINE OAuth 2.1ï¼ˆ/api/auth/line-oauth-initï¼‰
  â†’ LINE Callbackï¼ˆ/api/line/callbackï¼‰
  â†’ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ + ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ httpOnly Cookie ã«ä¿å­˜
  â†’ authMiddleware ãŒ Cookie ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ãƒ»æ¤œè¨¼
  â†’ UserService.getUserFromLiffToken() ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—/ä½œæˆ
```

### 4.2 ç¾è¡Œ users ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE users (
  id                    UUID PRIMARY KEY,
  line_user_id          TEXT NOT NULL UNIQUE,
  line_display_name     TEXT NOT NULL,
  line_picture_url      TEXT,
  line_status_message   TEXT,
  stripe_customer_id    TEXT,
  stripe_subscription_id TEXT,
  role                  TEXT NOT NULL DEFAULT 'trial'
                        CHECK (role IN ('trial','paid','admin','unavailable','owner')),
  owner_user_id         UUID REFERENCES users(id),
  owner_previous_role   TEXT,
  full_name             TEXT,
  last_login_at         TIMESTAMPTZ,
  created_at            TIMESTAMPTZ NOT NULL,
  updated_at            TIMESTAMPTZ NOT NULL
);
```

### 4.3 user_id ã‚’ä¿æŒã™ã‚‹å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

| # | ãƒ†ãƒ¼ãƒ–ãƒ«å | ã‚«ãƒ©ãƒ å | å‹ | FK | CASCADE |
|---|-----------|----------|-----|-----|---------|
| 1 | users | id (PK) | UUID | â€” | â€” |
| 2 | users | owner_user_id | UUID | YES | NO |
| 3 | chat_sessions | user_id | TEXT | NO | â€” |
| 4 | chat_messages | user_id | TEXT | NO | â€” |
| 5 | briefs | user_id | TEXT | NO | â€” |
| 6 | content_annotations | user_id | TEXT | NO | â€” |
| 7 | wordpress_settings | user_id | UUID | YES | CASCADE |
| 8 | gsc_credentials | user_id | UUID | YES | CASCADE |
| 9 | gsc_page_metrics | user_id | UUID | YES | CASCADE |
| 10 | gsc_article_evaluations | user_id | UUID | YES | CASCADE |
| 11 | gsc_article_evaluation_history | user_id | UUID | YES | CASCADE |
| 12 | gsc_query_metrics | user_id | UUID | YES | CASCADE |
| 13 | ga4_page_metrics_daily | user_id | UUID | YES | CASCADE |
| 14 | google_ads_credentials | user_id | UUID | YES | CASCADE |
| 15 | employee_invitations | owner_user_id | UUID | YES | CASCADE |
| 16 | employee_invitations | used_by_user_id | UUID | YES | NO |
| 17 | prompt_templates | created_by / updated_by | UUID | YES | SET NULL |
| 18 | prompt_versions | created_by | UUID | YES | SET NULL |
| 19 | session_heading_sections | (é–“æ¥: session_id â†’ chat_sessions) | â€” | â€” | CASCADE |
| 20 | session_combined_contents | (é–“æ¥: session_id â†’ chat_sessions) | â€” | â€” | CASCADE |

**æ³¨æ„**: TEXT å‹ user_idï¼ˆ#3ã€œ#6ï¼‰ã¯ FK åˆ¶ç´„ãŒãªã„ãŸã‚ã€ç§»è¡Œæ™‚ã«ã‚¢ãƒ—ãƒªå±¤ã§æ•´åˆæ€§ã‚’ä¿è¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

---

## 5. Phase 1: Magic Link èªè¨¼

### 5.1 DBå¤‰æ›´: users ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

```sql
-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: add_email_auth_to_users.sql

-- 1. email ã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE users ADD COLUMN email TEXT UNIQUE;

-- 2. èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€è­˜åˆ¥å­
ALTER TABLE users ADD COLUMN auth_provider TEXT NOT NULL DEFAULT 'line'
  CHECK (auth_provider IN ('line', 'email'));

-- 3. line_user_id ã® NOT NULL åˆ¶ç´„ã‚’è§£é™¤ï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ LINE ID ã‚’æŒãŸãªã„ï¼‰
ALTER TABLE users ALTER COLUMN line_user_id DROP NOT NULL;

-- 4. line_display_name ã® NOT NULL åˆ¶ç´„ã‚’è§£é™¤
ALTER TABLE users ALTER COLUMN line_display_name DROP NOT NULL;

-- 5. æ’ä»–åˆ¶ç´„: line ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ line_user_id å¿…é ˆã€email ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ email å¿…é ˆ
ALTER TABLE users ADD CONSTRAINT users_auth_provider_check
  CHECK (
    (auth_provider = 'line' AND line_user_id IS NOT NULL) OR
    (auth_provider = 'email' AND email IS NOT NULL)
  );

-- 6. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
-- ALTER TABLE users DROP CONSTRAINT users_auth_provider_check;
-- ALTER TABLE users ALTER COLUMN line_display_name SET NOT NULL;
-- ALTER TABLE users ALTER COLUMN line_user_id SET NOT NULL;
-- ALTER TABLE users DROP COLUMN auth_provider;
-- ALTER TABLE users DROP COLUMN email;
```

**å¤‰æ›´å¾Œã® users ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¸»è¦ã‚«ãƒ©ãƒ ï¼‰:**

```
users
â”œâ”€â”€ id                    UUID PK
â”œâ”€â”€ email                 TEXT UNIQUE (NULL: LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼)
â”œâ”€â”€ auth_provider         TEXT NOT NULL ('line' | 'email')
â”œâ”€â”€ line_user_id          TEXT UNIQUE (NULL: ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼)
â”œâ”€â”€ line_display_name     TEXT (NULL: ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼)
â”œâ”€â”€ line_picture_url      TEXT
â”œâ”€â”€ line_status_message   TEXT
â”œâ”€â”€ stripe_customer_id    TEXT
â”œâ”€â”€ stripe_subscription_id TEXT
â”œâ”€â”€ role                  TEXT NOT NULL
â”œâ”€â”€ owner_user_id         UUID FK
â”œâ”€â”€ full_name             TEXT
â”œâ”€â”€ last_login_at         TIMESTAMPTZ
â”œâ”€â”€ created_at            TIMESTAMPTZ
â””â”€â”€ updated_at            TIMESTAMPTZ
```

### 5.2 Magic Link èªè¨¼ãƒ•ãƒ­ãƒ¼

#### 5.2.1 ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

POST /api/auth/magic-link/send
  Body: { email: string }

ã‚µãƒ¼ãƒãƒ¼å‡¦ç†:
  1. email ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆZodï¼‰
  2. èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆcrypto.randomUUID()ï¼‰
  3. magic_link_tokens ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
     - token: TEXT UNIQUE
     - email: TEXT NOT NULL
     - expires_at: TIMESTAMPTZ (15åˆ†å¾Œ)
     - used_at: TIMESTAMPTZ (NULL)
     - created_at: TIMESTAMPTZ
  4. Magic Link ãƒ¡ãƒ¼ãƒ«é€ä¿¡
     - URL: {SITE_URL}/api/auth/magic-link/verify?token={token}
  5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹: { success: true }
```

#### 5.2.2 ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯

GET /api/auth/magic-link/verify?token={token}

ã‚µãƒ¼ãƒãƒ¼å‡¦ç†:
  1. magic_link_tokens ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
  2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³:
     - ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã™ã‚‹
     - used_at ãŒ NULLï¼ˆæœªä½¿ç”¨ï¼‰
     - expires_at > now()ï¼ˆæœ‰åŠ¹æœŸé™å†…ï¼‰
  3. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨æ¸ˆã¿ã«æ›´æ–°ï¼ˆused_at = now()ï¼‰
  4. users ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ email ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
     a. å­˜åœ¨ã—ãªã„å ´åˆ:
        - æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆauth_provider='email', role='trial'ï¼‰
     b. å­˜åœ¨ã™ã‚‹å ´åˆ:
        - last_login_at ã‚’æ›´æ–°
  5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»Cookie è¨­å®š
     - app_session_token: httpOnly Cookie (3æ—¥)
     - app_refresh_token: httpOnly Cookie (90æ—¥)
  6. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: / (ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸)
```

#### 5.2.3 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```
æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: app_sessions

CREATE TABLE app_sessions (
  id             UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id        UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  session_token  TEXT NOT NULL UNIQUE,
  refresh_token  TEXT NOT NULL UNIQUE,
  expires_at     TIMESTAMPTZ NOT NULL,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  last_active_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_app_sessions_user_id ON app_sessions(user_id);
CREATE INDEX idx_app_sessions_session_token ON app_sessions(session_token);
CREATE INDEX idx_app_sessions_expires_at ON app_sessions(expires_at);
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé–“:**

| ãƒˆãƒ¼ã‚¯ãƒ³ç¨®åˆ¥ | æœ‰åŠ¹æœŸé–“ | Cookie å±æ€§ |
|-------------|---------|------------|
| session_token | 3æ—¥ | httpOnly, Secure, SameSite=Lax |
| refresh_token | 90æ—¥ | httpOnly, Secure, SameSite=Lax |

**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼:**

```
GET /api/auth/refresh

ã‚µãƒ¼ãƒãƒ¼å‡¦ç†:
  1. Cookie ã‹ã‚‰ refresh_token ã‚’å–å¾—
  2. app_sessions ã‹ã‚‰æ¤œç´¢
  3. æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
  4. æ–°ã—ã„ session_token / refresh_token ã‚’ç”Ÿæˆ
  5. app_sessions ã‚’æ›´æ–°
  6. æ–°ã—ã„ Cookie ã‚’è¨­å®š
```

### 5.3 authMiddleware ã®äºŒé‡å¯¾å¿œ

ç¾è¡Œã® `authMiddleware` ã¯ LINE ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿å¯¾å¿œã€‚ãƒ¡ãƒ¼ãƒ«èªè¨¼ã¨ã®å…±å­˜ã®ãŸã‚ä»¥ä¸‹ã‚’å¤‰æ›´ã™ã‚‹ã€‚

```typescript
// èªè¨¼ãƒ•ãƒ­ãƒ¼åˆ†å²ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰

export async function ensureAuthenticated(
  request: NextRequest
): Promise<AuthenticatedUser> {

  // 1. ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆï¼‰
  const appSessionToken = getCookie('app_session_token');
  if (appSessionToken) {
    return authenticateBySession(appSessionToken);
  }

  // 2. LINE ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
  const lineAccessToken = getCookie('line_access_token');
  const lineRefreshToken = getCookie('line_refresh_token');
  if (lineAccessToken || lineRefreshToken) {
    return authenticateByLine(lineAccessToken, lineRefreshToken);
  }

  // 3. èªè¨¼ãªã—
  return { error: 'èªè¨¼ãŒå¿…è¦ã§ã™' };
}

async function authenticateBySession(
  sessionToken: string
): Promise<AuthenticatedUser> {
  // app_sessions ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ»ãƒ­ãƒ¼ãƒ«ãƒ»ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹ã‚’è¿”å´
  // æ—¢å­˜ã® viewMode / ã‚¹ã‚¿ãƒƒãƒ•é–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾é©ç”¨
}

async function authenticateByLine(
  accessToken: string | undefined,
  refreshToken: string | undefined
): Promise<AuthenticatedUser> {
  // æ—¢å­˜ã® LINE èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰
}
```

**é‡è¦**: `AuthenticatedUser` ã® `lineUserId` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ `null` ã¨ãªã‚‹ã€‚
ä¸‹æµã§ `lineUserId` ã‚’å‚ç…§ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’æ´—ã„å‡ºã—ã€`null` å®‰å…¨ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#### 5.3.1 lineUserId å‚ç…§ç®‡æ‰€ã®å½±éŸ¿ç¯„å›²

| ãƒ•ã‚¡ã‚¤ãƒ« | ç”¨é€” | å¯¾å¿œæ–¹é‡ |
|---------|------|---------|
| `auth.middleware.ts` | LINE ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— | ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ— |
| `userService.ts` | `getUserFromLiffToken()` | ãƒ¡ãƒ¼ãƒ«ç”¨ã® `getUserByEmail()` ã‚’æ–°è¨­ |
| `userService.ts` | `updateStripeCustomerId()` | `lineUserId` â†’ `userId` ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ |
| `userService.ts` | `updateStripeSubscriptionId()` | åŒä¸Š |
| `supabaseService.ts` | `getUserByLineId()` | ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `getUserByEmail()` ã‚’ä½¿ç”¨ |
| `login.actions.ts` | LINE ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— | ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åˆ¥çµŒè·¯ |

### 5.4 ãƒ­ã‚°ã‚¤ãƒ³ UI

#### 5.4.1 ç”»é¢æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                GrowMate                 â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³          â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ email@example.com           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ âœ‰ï¸    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€ ã¾ãŸã¯ â”€â”€â”€â”€â”€â”€â”€           â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   LINEã§ãƒ­ã‚°ã‚¤ãƒ³ ğŸ’¬          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.4.2 ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                GrowMate                 â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ          â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  user@example.com ã«              â”‚  â”‚
â”‚  â”‚  ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚    â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦    â”‚  â”‚
â”‚  â”‚  ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚      â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â€» 15åˆ†ä»¥å†…ã«å±Šã‹ãªã„å ´åˆã¯       â”‚  â”‚
â”‚  â”‚    å†é€ä¿¡ã—ã¦ãã ã•ã„ã€‚            â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚      ãƒªãƒ³ã‚¯ã‚’å†é€ä¿¡          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.4.3 UI é·ç§»ãƒ•ãƒ­ãƒ¼

```
/login
  â”œâ”€â”€ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› â†’ POST /api/auth/magic-link/send â†’ é€ä¿¡å®Œäº†ç”»é¢
  â”‚                                                          â””â”€â”€ å†é€ä¿¡ãƒœã‚¿ãƒ³
  â”‚
  â””â”€â”€ LINE ã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ /api/auth/line-oauth-init â†’ LINE OAuth â†’ /api/line/callback â†’ /
```

### 5.5 ãƒ¡ãƒ¼ãƒ«é€ä¿¡åŸºç›¤

#### 5.5.1 é€ä¿¡æ–¹æ³•ã®é¸æŠ

Supabase ã®çµ„ã¿è¾¼ã¿ãƒ¡ãƒ¼ãƒ«æ©Ÿèƒ½ï¼ˆ`supabase.auth.signInWithOtp`ï¼‰ã¯ä½¿ç”¨ã›ãšã€ç‹¬è‡ªã«ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã¨ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’è¡Œã†ã€‚

ç†ç”±:
- æ—¢å­˜ã®ç‹¬è‡ªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`public.users`ï¼‰ã¨ã®æ•´åˆæ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚
- Supabase Auth ã® `auth.users` ã¨ã®äºŒé‡ç®¡ç†ã‚’é¿ã‘ã‚‹ãŸã‚
- LINE èªè¨¼ã¨ã®çµ±åˆåˆ¶å¾¡ã‚’ã‚¢ãƒ—ãƒªå±¤ã§ä¸€å…ƒç®¡ç†ã™ã‚‹ãŸã‚

#### 5.5.2 ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹

å¤–éƒ¨ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ **Resend** ã‚’æ¡ç”¨ã™ã‚‹ï¼ˆå€™è£œï¼‰ã€‚

```typescript
// src/server/services/emailService.ts

interface EmailService {
  sendMagicLink(email: string, token: string): Promise<void>;
}
```

### 5.6 ç’°å¢ƒå¤‰æ•°è¿½åŠ 

```env
# ãƒ¡ãƒ¼ãƒ«èªè¨¼
EMAIL_PROVIDER=resend              # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ—ãƒ­ãƒã‚¤ãƒ€
RESEND_API_KEY=re_xxxxx            # Resend API ã‚­ãƒ¼
EMAIL_FROM=noreply@growmate.jp     # é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹
```

`src/env.ts` ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã€‚ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆã¯ `EMAIL_PROVIDER` ã‚’æœªè¨­å®šã«ã™ã‚‹ã€‚

### 5.7 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

```
app/api/auth/magic-link/send/route.ts       # Magic Link é€ä¿¡ API
app/api/auth/magic-link/verify/route.ts     # ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ API
app/api/auth/refresh/route.ts               # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆæ—¢å­˜æ‹¡å¼µï¼‰
app/login/page.tsx                          # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆæ—¢å­˜æ”¹ä¿®ï¼‰
src/server/services/emailService.ts         # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹
src/server/services/sessionService.ts       # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹
supabase/migrations/XXXXXX_add_email_auth.sql
supabase/migrations/XXXXXX_create_magic_link_tokens.sql
supabase/migrations/XXXXXX_create_app_sessions.sql
```

---

## 6. Phase 1.5: LINE â†’ Email ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œ

### 6.1 æ¦‚è¦

æ—¢å­˜ã® LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã§ãã‚‹ã‚»ãƒ«ãƒ•ã‚µãƒ¼ãƒ“ã‚¹æ©Ÿèƒ½ã€‚
ç§»è¡Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»»æ„ã§ã‚ã‚Šã€LINE ãƒ­ã‚°ã‚¤ãƒ³ã¯ç§»è¡Œå¾Œã‚‚ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«ç¶­æŒã•ã‚Œã‚‹ã€‚

### 6.2 ç§»è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ A: æ–°è¦ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®çµ±åˆï¼ˆä¸»è¦ãƒ•ãƒ­ãƒ¼ï¼‰

```
å‰æ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿

1. LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Aï¼‰ãŒè¨­å®šç”»é¢ã§ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã€ã‚’é¸æŠ
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
3. ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã« Magic Link ã‚’é€ä¿¡ï¼ˆæ‰€æœ‰æ¨©ç¢ºèªï¼‰
4. Magic Link ã‚¯ãƒªãƒƒã‚¯ã§æ¤œè¨¼å®Œäº†
5. æ–°è¦ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Bï¼‰ã‚’ä½œæˆï¼ˆauth_provider='email'ï¼‰
6. UUID-A ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ UUID-B ã«ç§»è¡Œï¼ˆmigrate_user_data RPCï¼‰
7. UUID-A ã‚’ç„¡åŠ¹åŒ–ï¼ˆrole='unavailable', auth_provider ãã®ã¾ã¾ï¼‰
8. UUID-B ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ B: æ—¢å­˜ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®çµ±åˆ

```
å‰æ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ LINE ã¨ Email ã®ä¸¡æ–¹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ—¢ã«æŒã£ã¦ã„ã‚‹å ´åˆ

1. LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Aï¼‰ãŒè¨­å®šç”»é¢ã§ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã€ã‚’é¸æŠ
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›
3. å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ãŒæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Bï¼‰ã«ç´ä»˜ã„ã¦ã„ã‚‹å ´åˆ
4. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°: ã€Œã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¯æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¾ã™ã‹ï¼Ÿã€
   â€» UUID-B å´ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ä¸¡è€…ã®ãƒ‡ãƒ¼ã‚¿ãŒçµ±åˆã•ã‚Œã‚‹
5. Magic Link ã§æ‰€æœ‰æ¨©ç¢ºèª
6. UUID-A ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ UUID-B ã«ç§»è¡Œï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ï¼‰
7. UUID-A ã‚’ç„¡åŠ¹åŒ–
8. UUID-B ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
```

### 6.3 ç§»è¡Œãƒ•ãƒ­ãƒ¼è©³ç´°

#### 6.3.1 ã‚¹ãƒ†ãƒƒãƒ— 1: ç§»è¡Œé–‹å§‹ï¼ˆè¨­å®šç”»é¢ï¼‰

```
ã‚¢ã‚¯ã‚»ã‚¹æ¡ä»¶:
  - LINE èªè¨¼ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆauth_provider = 'line'ï¼‰
  - role ãŒ 'unavailable' ã§ãªã„

è¡¨ç¤ºå ´æ‰€: /settings ã¾ãŸã¯ /accountï¼ˆæ–°è¦ãƒšãƒ¼ã‚¸ï¼‰
```

#### 6.3.2 ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ãƒ»æ¤œè¨¼

```
POST /api/auth/account-migration/initiate
  Headers: Cookie (LINE ã‚»ãƒƒã‚·ãƒ§ãƒ³)
  Body: { email: string }

ã‚µãƒ¼ãƒãƒ¼å‡¦ç†:
  1. authMiddleware ã§ LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼
  2. email ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆZod: ãƒ¡ãƒ¼ãƒ«å½¢å¼ + ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯ï¼‰
  3. åŒä¸€ãƒ¡ãƒ¼ãƒ«ã§æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
     a. å­˜åœ¨ã™ã‚‹å ´åˆ: ãƒ‘ã‚¿ãƒ¼ãƒ³ B ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
     b. å­˜åœ¨ã—ãªã„å ´åˆ: ãƒ‘ã‚¿ãƒ¼ãƒ³ A
  4. migration_tokens ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
     - token: crypto.randomUUID()
     - source_user_id: UUID-A (LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼)
     - target_email: å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
     - target_user_id: UUID-B (æ—¢å­˜ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼) or NULL
     - migration_type: 'new' | 'merge'
     - expires_at: now() + 30åˆ†
     - status: 'pending'
  5. Magic Link ãƒ¡ãƒ¼ãƒ«é€ä¿¡
     - URL: {SITE_URL}/api/auth/account-migration/verify?token={token}
  6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
     { success: true, migrationType: 'new' | 'merge' }
```

#### 6.3.3 ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ãƒ»ç§»è¡Œç¢ºèª

```
GET /api/auth/account-migration/verify?token={token}

ã‚µãƒ¼ãƒãƒ¼å‡¦ç†:
  1. migration_tokens ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»æ¤œè¨¼
     - å­˜åœ¨ç¢ºèªã€æœªä½¿ç”¨ç¢ºèªã€æœ‰åŠ¹æœŸé™ç¢ºèª
  2. ç¢ºèªç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: /account-migration/confirm?token={token}
```

#### 6.3.4 ã‚¹ãƒ†ãƒƒãƒ— 4: ç§»è¡Œå®Ÿè¡Œ

```
ç¢ºèªç”»é¢ã§ã€Œç§»è¡Œã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

POST /api/auth/account-migration/execute
  Body: { token: string }

ã‚µãƒ¼ãƒãƒ¼å‡¦ç†:
  1. migration_tokens ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»å†æ¤œè¨¼
  2. status ã‚’ 'processing' ã«æ›´æ–°ï¼ˆäºŒé‡å®Ÿè¡Œé˜²æ­¢ï¼‰
  3. ãƒ‘ã‚¿ãƒ¼ãƒ³ A ã®å ´åˆ:
     a. æ–°è¦ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Bï¼‰ã‚’ä½œæˆ
  4. migrate_user_data RPC ã‚’å®Ÿè¡Œï¼ˆå¾Œè¿° 6.4ï¼‰
  5. ç§»è¡Œå…ƒãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Aï¼‰ã‚’ç„¡åŠ¹åŒ–:
     - role = 'unavailable'
     - updated_at = now()
  6. migration_tokens.status ã‚’ 'completed' ã«æ›´æ–°
  7. UUID-B ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆãƒ»Cookie è¨­å®š
  8. ãƒ¬ã‚¹ãƒãƒ³ã‚¹: { success: true, redirectTo: '/' }

ã‚¨ãƒ©ãƒ¼æ™‚:
  - migration_tokens.status ã‚’ 'failed' ã«æ›´æ–°
  - ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ migration_tokens.error_message ã«è¨˜éŒ²
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å†è©¦è¡Œã‚’æ¡ˆå†…
```

### 6.4 ç§»è¡Œ RPC é–¢æ•°: `migrate_user_data`

```sql
-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: add_migrate_user_data_rpc.sql

CREATE OR REPLACE FUNCTION migrate_user_data(
  p_source_user_id UUID,  -- ç§»è¡Œå…ƒï¼ˆLINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
  p_target_user_id UUID   -- ç§»è¡Œå…ˆï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
)
RETURNS TABLE (
  migrated_tables TEXT,
  migrated_rows   INT
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_source_exists BOOLEAN;
  v_target_exists BOOLEAN;
  v_row_count     INT;
BEGIN
  -- ============================================
  -- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  -- ============================================
  SELECT EXISTS(SELECT 1 FROM users WHERE id = p_source_user_id) INTO v_source_exists;
  SELECT EXISTS(SELECT 1 FROM users WHERE id = p_target_user_id) INTO v_target_exists;

  IF NOT v_source_exists THEN
    RAISE EXCEPTION 'ç§»è¡Œå…ƒãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“: %', p_source_user_id;
  END IF;

  IF NOT v_target_exists THEN
    RAISE EXCEPTION 'ç§»è¡Œå…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“: %', p_target_user_id;
  END IF;

  IF p_source_user_id = p_target_user_id THEN
    RAISE EXCEPTION 'ç§»è¡Œå…ƒã¨ç§»è¡Œå…ˆãŒåŒä¸€ã§ã™';
  END IF;

  -- ============================================
  -- TEXT å‹ user_id ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆFK åˆ¶ç´„ãªã—ï¼‰
  -- ============================================

  -- 1. chat_sessions
  UPDATE chat_sessions
    SET user_id = p_target_user_id::TEXT
    WHERE user_id = p_source_user_id::TEXT;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'chat_sessions';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 2. chat_messages
  UPDATE chat_messages
    SET user_id = p_target_user_id::TEXT
    WHERE user_id = p_source_user_id::TEXT;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'chat_messages';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 3. briefsï¼ˆUNIQUE åˆ¶ç´„ã‚ã‚Š: user_idï¼‰
  --    ç§»è¡Œå…ˆã«æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãƒãƒ¼ã‚¸ä¸å¯ â†’ ç§»è¡Œå…ƒã‚’å„ªå…ˆ
  IF EXISTS (SELECT 1 FROM briefs WHERE user_id = p_target_user_id::TEXT) THEN
    -- ç§»è¡Œå…ˆã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ: ç§»è¡Œå…ƒãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆç§»è¡Œå…ˆã‚’å„ªå…ˆï¼‰
    DELETE FROM briefs WHERE user_id = p_source_user_id::TEXT;
    GET DIAGNOSTICS v_row_count = ROW_COUNT;
    migrated_tables := 'briefs (skipped: target exists)';
    migrated_rows := 0;
  ELSE
    UPDATE briefs
      SET user_id = p_target_user_id::TEXT
      WHERE user_id = p_source_user_id::TEXT;
    GET DIAGNOSTICS v_row_count = ROW_COUNT;
    migrated_tables := 'briefs';
    migrated_rows := v_row_count;
  END IF;
  RETURN NEXT;

  -- 4. content_annotationsï¼ˆUNIQUE åˆ¶ç´„: user_id, wp_post_idï¼‰
  --    ç§»è¡Œå…ˆã«åŒä¸€ wp_post_id ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ç§»è¡Œå…ƒã‚’å‰Šé™¤
  DELETE FROM content_annotations
    WHERE user_id = p_source_user_id::TEXT
      AND (user_id, wp_post_id) IN (
        SELECT p_source_user_id::TEXT, wp_post_id
        FROM content_annotations
        WHERE user_id = p_target_user_id::TEXT
      );

  UPDATE content_annotations
    SET user_id = p_target_user_id::TEXT
    WHERE user_id = p_source_user_id::TEXT;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'content_annotations';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- ============================================
  -- UUID å‹ user_id ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆFK CASCADE ã‚ã‚Šï¼‰
  -- ============================================

  -- 5. wordpress_settingsï¼ˆUNIQUE: user_idï¼‰
  IF EXISTS (SELECT 1 FROM wordpress_settings WHERE user_id = p_target_user_id) THEN
    DELETE FROM wordpress_settings WHERE user_id = p_source_user_id;
    migrated_tables := 'wordpress_settings (skipped: target exists)';
    migrated_rows := 0;
  ELSE
    UPDATE wordpress_settings
      SET user_id = p_target_user_id
      WHERE user_id = p_source_user_id;
    GET DIAGNOSTICS v_row_count = ROW_COUNT;
    migrated_tables := 'wordpress_settings';
    migrated_rows := v_row_count;
  END IF;
  RETURN NEXT;

  -- 6. gsc_credentialsï¼ˆUNIQUE: user_idï¼‰
  IF EXISTS (SELECT 1 FROM gsc_credentials WHERE user_id = p_target_user_id) THEN
    DELETE FROM gsc_credentials WHERE user_id = p_source_user_id;
    migrated_tables := 'gsc_credentials (skipped: target exists)';
    migrated_rows := 0;
  ELSE
    UPDATE gsc_credentials
      SET user_id = p_target_user_id
      WHERE user_id = p_source_user_id;
    GET DIAGNOSTICS v_row_count = ROW_COUNT;
    migrated_tables := 'gsc_credentials';
    migrated_rows := v_row_count;
  END IF;
  RETURN NEXT;

  -- 7. gsc_page_metrics
  UPDATE gsc_page_metrics
    SET user_id = p_target_user_id
    WHERE user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'gsc_page_metrics';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 8. gsc_article_evaluations
  UPDATE gsc_article_evaluations
    SET user_id = p_target_user_id
    WHERE user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'gsc_article_evaluations';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 9. gsc_article_evaluation_history
  UPDATE gsc_article_evaluation_history
    SET user_id = p_target_user_id
    WHERE user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'gsc_article_evaluation_history';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 10. gsc_query_metrics
  UPDATE gsc_query_metrics
    SET user_id = p_target_user_id
    WHERE user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'gsc_query_metrics';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 11. ga4_page_metrics_daily
  UPDATE ga4_page_metrics_daily
    SET user_id = p_target_user_id
    WHERE user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'ga4_page_metrics_daily';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 12. google_ads_credentialsï¼ˆUNIQUE: user_idï¼‰
  IF EXISTS (SELECT 1 FROM google_ads_credentials WHERE user_id = p_target_user_id) THEN
    DELETE FROM google_ads_credentials WHERE user_id = p_source_user_id;
    migrated_tables := 'google_ads_credentials (skipped: target exists)';
    migrated_rows := 0;
  ELSE
    UPDATE google_ads_credentials
      SET user_id = p_target_user_id
      WHERE user_id = p_source_user_id;
    GET DIAGNOSTICS v_row_count = ROW_COUNT;
    migrated_tables := 'google_ads_credentials';
    migrated_rows := v_row_count;
  END IF;
  RETURN NEXT;

  -- ============================================
  -- ã‚¹ã‚¿ãƒƒãƒ•ãƒ»æ‹›å¾…é–¢é€£
  -- ============================================

  -- 13. employee_invitations: owner_user_id ã®ä»˜æ›¿ãˆ
  UPDATE employee_invitations
    SET owner_user_id = p_target_user_id
    WHERE owner_user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'employee_invitations (owner)';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 14. employee_invitations: used_by_user_id ã®ä»˜æ›¿ãˆ
  UPDATE employee_invitations
    SET used_by_user_id = p_target_user_id
    WHERE used_by_user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'employee_invitations (used_by)';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- 15. users.owner_user_id: ã‚¹ã‚¿ãƒƒãƒ•ã®è¦ªå‚ç…§ã‚’ä»˜æ›¿ãˆ
  UPDATE users
    SET owner_user_id = p_target_user_id
    WHERE owner_user_id = p_source_user_id;
  GET DIAGNOSTICS v_row_count = ROW_COUNT;
  migrated_tables := 'users (staff owner_user_id)';
  migrated_rows := v_row_count;
  RETURN NEXT;

  -- ============================================
  -- ãƒ­ãƒ¼ãƒ«ãƒ»ã‚µãƒ–ã‚¹ã‚¯æƒ…å ±ã®å¼•ãç¶™ã
  -- ============================================

  -- 16. ç§»è¡Œå…ƒã®ãƒ­ãƒ¼ãƒ«ãƒ»Stripeæƒ…å ±ã‚’ç§»è¡Œå…ˆã«å¼•ãç¶™ã
  UPDATE users
    SET
      role = (SELECT role FROM users WHERE id = p_source_user_id),
      stripe_customer_id = (SELECT stripe_customer_id FROM users WHERE id = p_source_user_id),
      stripe_subscription_id = (SELECT stripe_subscription_id FROM users WHERE id = p_source_user_id),
      owner_user_id = (SELECT owner_user_id FROM users WHERE id = p_source_user_id),
      owner_previous_role = (SELECT owner_previous_role FROM users WHERE id = p_source_user_id),
      updated_at = now()
    WHERE id = p_target_user_id;
  migrated_tables := 'users (role/stripe transfer)';
  migrated_rows := 1;
  RETURN NEXT;

  -- 17. ç§»è¡Œå…ƒã‚’ç„¡åŠ¹åŒ–
  UPDATE users
    SET
      role = 'unavailable',
      stripe_customer_id = NULL,
      stripe_subscription_id = NULL,
      owner_user_id = NULL,
      updated_at = now()
    WHERE id = p_source_user_id;
  migrated_tables := 'users (source deactivated)';
  migrated_rows := 1;
  RETURN NEXT;

  RETURN;
END;
$$;

-- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
-- DROP FUNCTION IF EXISTS migrate_user_data(UUID, UUID);
```

### 6.5 migration_tokens ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE migration_tokens (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  token           TEXT NOT NULL UNIQUE,
  source_user_id  UUID NOT NULL REFERENCES users(id),
  target_email    TEXT NOT NULL,
  target_user_id  UUID REFERENCES users(id),  -- NULL: æ–°è¦ä½œæˆãƒ‘ã‚¿ãƒ¼ãƒ³
  migration_type  TEXT NOT NULL CHECK (migration_type IN ('new', 'merge')),
  status          TEXT NOT NULL DEFAULT 'pending'
                  CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  error_message   TEXT,
  expires_at      TIMESTAMPTZ NOT NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  completed_at    TIMESTAMPTZ
);

CREATE INDEX idx_migration_tokens_token ON migration_tokens(token);
CREATE INDEX idx_migration_tokens_source ON migration_tokens(source_user_id);

-- æœ‰åŠ¹æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•å‰Šé™¤ï¼ˆ30æ—¥å¾Œï¼‰
-- pg_cron ã¾ãŸã¯å®šæœŸãƒãƒƒãƒã§å®Ÿè¡Œ
```

### 6.6 ç§»è¡Œ UIï¼ˆã‚¹ãƒ†ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼‰

#### 6.6.1 Step 1: ç§»è¡Œæ¡ˆå†…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š                              â”‚
â”‚                                             â”‚
â”‚  ç¾åœ¨ã®èªè¨¼æ–¹æ³•: LINE                        â”‚
â”‚  LINE ID: @user_display_name               â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹     â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã« â”‚    â”‚
â”‚  â”‚  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç§»è¡Œã—ã¾ã™ã€‚            â”‚    â”‚
â”‚  â”‚  ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«å¼•ãç¶™ãŒã‚Œ  â”‚    â”‚
â”‚  â”‚  ã¾ã™ã€‚                             â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  âš ï¸ ç§»è¡Œå¾Œã¯ LINE ãƒ­ã‚°ã‚¤ãƒ³ã¯         â”‚    â”‚
â”‚  â”‚     ä½¿ç”¨ã§ããªããªã‚Šã¾ã™             â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›          â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  [ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡]                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.6.2 Step 2: ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œ                              â”‚
â”‚                                             â”‚
â”‚  âœ‰ï¸ ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ                 â”‚
â”‚                                             â”‚
â”‚  user@example.com ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’             â”‚
â”‚  é€ä¿¡ã—ã¾ã—ãŸã€‚                              â”‚
â”‚  ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦               â”‚
â”‚  ç§»è¡Œã‚’ç¶šè¡Œã—ã¦ãã ã•ã„ã€‚                    â”‚
â”‚                                             â”‚
â”‚  â€» 30åˆ†ä»¥å†…ã«ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„    â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.6.3 Step 3: ç§»è¡Œç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯å…ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œã®ç¢ºèª                        â”‚
â”‚                                             â”‚
â”‚  ä»¥ä¸‹ã®å†…å®¹ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç§»è¡Œã—ã¾ã™:          â”‚
â”‚                                             â”‚
â”‚  ç§»è¡Œå…ƒ: LINE (@user_display_name)          â”‚
â”‚  ç§»è¡Œå…ˆ: user@example.com                   â”‚
â”‚                                             â”‚
â”‚  ç§»è¡Œã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿:                           â”‚
â”‚  âœ“ ãƒãƒ£ãƒƒãƒˆå±¥æ­´                              â”‚
â”‚  âœ“ äº‹æ¥­è€…æƒ…å ±                                â”‚
â”‚  âœ“ WordPress è¨­å®š                            â”‚
â”‚  âœ“ GSC/GA4 ãƒ‡ãƒ¼ã‚¿                            â”‚
â”‚  âœ“ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±                     â”‚
â”‚  âœ“ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†æƒ…å ±                           â”‚
â”‚                                             â”‚
â”‚  âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚                â”‚
â”‚  ç§»è¡Œå¾Œã¯ LINE ãƒ­ã‚°ã‚¤ãƒ³ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚      â”‚
â”‚                                             â”‚
â”‚  [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]        [ç§»è¡Œã‚’å®Ÿè¡Œã™ã‚‹]         â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.6.4 Step 4: ç§»è¡Œå®Œäº†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œå®Œäº† âœ…                       â”‚
â”‚                                             â”‚
â”‚  ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚             â”‚
â”‚                                             â”‚
â”‚  ä»Šå¾Œã¯ user@example.com ã§                  â”‚
â”‚  ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚                       â”‚
â”‚                                             â”‚
â”‚  ç§»è¡Œçµæœ:                                   â”‚
â”‚  ãƒ»ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³: 24ä»¶                   â”‚
â”‚  ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: 156ä»¶                          â”‚
â”‚  ãƒ»ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: 12ä»¶                       â”‚
â”‚  ãƒ»ãã®ä»–ãƒ‡ãƒ¼ã‚¿: ã™ã¹ã¦ç§»è¡Œå®Œäº†               â”‚
â”‚                                             â”‚
â”‚  [ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸]                           â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.7 ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

#### 6.7.1 ã‚¹ã‚¿ãƒƒãƒ•ãŒã‚ªãƒ¼ãƒŠãƒ¼ã‚’ç§»è¡Œã™ã‚‹å ´åˆ

```
çŠ¶æ³: LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-A, role='paid', owner_user_id=UUID-Xï¼‰ãŒãƒ¡ãƒ¼ãƒ«ã«ç§»è¡Œ

å¯¾å¿œ:
  1. migrate_user_data RPC å†…ã§ users.owner_user_id ã¯å¤‰æ›´ã—ãªã„
     ï¼ˆUUID-A â†’ UUID-B ã«ç§»è¡Œã—ã¦ã‚‚ã€owner_user_id=UUID-X ã®ã¾ã¾ï¼‰
  2. ãŸã ã— owner å´ã® get_accessible_user_ids ã¯ UUID-B ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚‹
  3. RPC å†…ã§ owner å´ã®å‚ç…§ãŒæ­£ã—ã UUID-B ã‚’æŒ‡ã™ã‚ˆã†æ›´æ–°æ¸ˆã¿ï¼ˆã‚¹ãƒ†ãƒƒãƒ— 15ï¼‰
```

#### 6.7.2 ã‚ªãƒ¼ãƒŠãƒ¼ãŒã‚¹ã‚¿ãƒƒãƒ•ã‚’æŒã¤å ´åˆ

```
çŠ¶æ³: LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-A, role='owner'ï¼‰ãŒãƒ¡ãƒ¼ãƒ«ã«ç§»è¡Œã€‚
      ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆUUID-S, owner_user_id=UUID-Aï¼‰ãŒå­˜åœ¨ã€‚

å¯¾å¿œ:
  1. ã‚¹ã‚¿ãƒƒãƒ•ã® owner_user_id ã‚’ UUID-A â†’ UUID-B ã«æ›´æ–°ï¼ˆRPC ã‚¹ãƒ†ãƒƒãƒ— 15ï¼‰
  2. employee_invitations ã® owner_user_id ã‚‚ UUID-B ã«æ›´æ–°ï¼ˆRPC ã‚¹ãƒ†ãƒƒãƒ— 13ï¼‰
  3. ç§»è¡Œå¾Œã‚‚ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ã‚ªãƒ¼ãƒŠãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒç¶­æŒã•ã‚Œã‚‹
```

#### 6.7.3 Stripe ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä»˜æ›¿ãˆ

```
çŠ¶æ³: LINE ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUUID-Aï¼‰ãŒ Stripe ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒã¤

å¯¾å¿œ:
  1. RPC å†…ã§ stripe_customer_id / stripe_subscription_id ã‚’ UUID-B ã«è»¢è¨˜ï¼ˆã‚¹ãƒ†ãƒƒãƒ— 16ï¼‰
  2. Stripe å´ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¯ä¸è¦
     ï¼ˆStripe ã¯ customer_id ã§ç®¡ç†ã—ã¦ãŠã‚Šã€ã‚¢ãƒ—ãƒªå´ã® user_id ã¯å‚ç…§ã—ãªã„ï¼‰
  3. ãŸã ã— stripe_customer_id ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã™ã‚‹ç®‡æ‰€ï¼ˆwebhook ç­‰ï¼‰ãŒ
     UUID-B ã‚’æ­£ã—ãè¿”ã™ã“ã¨ã‚’ç¢ºèªã™ã‚‹
```

#### 6.7.4 ç§»è¡Œä¸­ã®ã‚¨ãƒ©ãƒ¼ãƒ»ä¸­æ–­

```
å¯¾å¿œæ–¹é‡:
  - RPC ã¯å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€é€”ä¸­ã‚¨ãƒ©ãƒ¼ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - migration_tokens.status = 'failed' ã«æ›´æ–°ã—ã€error_message ã«è©³ç´°ã‚’è¨˜éŒ²
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€ã¨è¡¨ç¤º
  - å†è©¦è¡Œ: æ–°ã—ã„ migration_token ã‚’ç™ºè¡Œã—ã¦å†å®Ÿè¡Œå¯èƒ½
```

#### 6.7.5 ç§»è¡Œä¸­ã®åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹

```
å¯¾å¿œæ–¹é‡:
  - migration_tokens.status = 'processing' ã‚’ã‚»ãƒãƒ•ã‚©ã¨ã—ã¦ä½¿ç”¨
  - åŒä¸€ source_user_id ã«å¯¾ã—ã¦ status='processing' ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€æ–°è¦ç§»è¡Œã‚’æ‹’å¦
  - RPC å®Ÿè¡Œå‰ã« SELECT ... FOR UPDATE ã§ç§»è¡Œå…ƒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ­ãƒƒã‚¯
```

#### 6.7.6 prompt_templates / prompt_versions ã® created_by

```
çŠ¶æ³: ç®¡ç†è€…ï¼ˆadminï¼‰ãŒç§»è¡Œã™ã‚‹å ´åˆã€created_by ã« UUID-A ãŒå…¥ã£ã¦ã„ã‚‹å¯èƒ½æ€§

å¯¾å¿œ:
  - prompt_templates.created_by / updated_by ã¯ ON DELETE SET NULL ã®ãŸã‚ã€
    ç§»è¡Œå…ƒå‰Šé™¤æ™‚ã« NULL ã«ãªã‚‹ãŒã€ç§»è¡Œã§ã¯ãªãç„¡åŠ¹åŒ–ã®ãŸã‚å½±éŸ¿ãªã—
  - æ˜ç¤ºçš„ã« UUID-B ã¸ã®ä»˜æ›¿ãˆã¯è¡Œã‚ãªã„ï¼ˆç®¡ç†è€…ã®ä½œæˆå±¥æ­´ã¨ã—ã¦ UUID-A ã‚’ä¿æŒï¼‰
  - ç†ç”±: prompt_templates ã¯å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã§ã‚ã‚Šã€ä½œæˆè€…æƒ…å ±ã®æ›¸ãæ›ãˆã¯ç›£æŸ»ä¸Šæœ›ã¾ã—ããªã„
```

### 6.8 ç§»è¡Œ API ä¸€è¦§

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç”¨é€” |
|---------|---------------|------|
| POST | `/api/auth/account-migration/initiate` | ç§»è¡Œé–‹å§‹ãƒ»ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ |
| GET | `/api/auth/account-migration/verify` | ãƒ¡ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ |
| POST | `/api/auth/account-migration/execute` | ç§»è¡Œå®Ÿè¡Œ |
| GET | `/api/auth/account-migration/status` | ç§»è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª |

### 6.9 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

```
app/api/auth/account-migration/initiate/route.ts
app/api/auth/account-migration/verify/route.ts
app/api/auth/account-migration/execute/route.ts
app/api/auth/account-migration/status/route.ts
app/account-migration/confirm/page.tsx
app/account-migration/complete/page.tsx
src/server/services/migrationService.ts
supabase/migrations/XXXXXX_create_migration_tokens.sql
supabase/migrations/XXXXXX_add_migrate_user_data_rpc.sql
```

---

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 7.1 ãƒ¡ãƒ¼ãƒ«èªè¨¼

| è„…å¨ | å¯¾ç­– |
|------|------|
| Magic Link ã®ç›—è´ | HTTPS å¿…é ˆã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯1å›é™ã‚Šä½¿ç”¨ã€‚æœ‰åŠ¹æœŸé™15åˆ† |
| ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ | ãƒˆãƒ¼ã‚¯ãƒ³ã¯ UUID v4ï¼ˆ128bit ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ï¼‰ã€‚ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å®Ÿè£… |
| ãƒ¡ãƒ¼ãƒ«åˆ—æŒ™æ”»æ’ƒ | å­˜åœ¨/éå­˜åœ¨ã«é–¢ã‚ã‚‰ãšåŒä¸€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ | httpOnly + Secure + SameSite Cookie |
| CSRF | SameSite=Lax Cookie + Origin ãƒã‚§ãƒƒã‚¯ |

### 7.2 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç§»è¡Œ

| è„…å¨ | å¯¾ç­– |
|------|------|
| ä»–äººã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ä¸æ­£ç§»è¡Œ | Magic Link ã§ãƒ¡ãƒ¼ãƒ«æ‰€æœ‰æ¨©ã‚’æ¤œè¨¼ |
| äºŒé‡ç§»è¡Œ | migration_tokens.status ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡ |
| ç§»è¡Œä¸­ã®ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ | å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ + FOR UPDATE ãƒ­ãƒƒã‚¯ |
| ç§»è¡Œå¾Œã®æ—§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‚ªç”¨ | role='unavailable' ã«è¨­å®šã€‚LINE ãƒˆãƒ¼ã‚¯ãƒ³ã§ã®ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |
| ç§»è¡Œãƒˆãƒ¼ã‚¯ãƒ³ã®å†åˆ©ç”¨ | used_at ãƒã‚§ãƒƒã‚¯ + status ç®¡ç† |

### 7.3 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | åˆ¶é™ |
|---------------|------|
| Magic Link é€ä¿¡ | åŒä¸€ãƒ¡ãƒ¼ãƒ«: 3å›/15åˆ† |
| ç§»è¡Œé–‹å§‹ | åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼: 3å›/1æ™‚é–“ |
| ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ | åŒä¸€IP: 10å›/15åˆ† |

---

## 8. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

### Phase 1: Magic Link èªè¨¼ â€” 7-13æ—¥

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆusers æ‹¡å¼µ + magic_link_tokens + app_sessionsï¼‰ | 1-2æ—¥ |
| ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆResend é€£æºï¼‰ | 1-2æ—¥ |
| Magic Link é€ä¿¡/æ¤œè¨¼ API | 1-2æ—¥ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ | 1-2æ—¥ |
| authMiddleware ã® LINE/Email äºŒé‡å¯¾å¿œ | 2-3æ—¥ |
| ãƒ­ã‚°ã‚¤ãƒ³ UI æ”¹ä¿® | 1-2æ—¥ |

### Phase 1.5: LINEâ†’Email ç§»è¡Œ â€” 9-15æ—¥

| ã‚¿ã‚¹ã‚¯ | å·¥æ•° |
|--------|------|
| DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆmigration_tokens + migrate_user_data RPCï¼‰ | 2-3æ—¥ |
| ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç´ä»˜ã‘æ¤œè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆAPI 4æœ¬ï¼‰ | 2-3æ—¥ |
| ç§»è¡Œ UIï¼ˆã‚¹ãƒ†ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ 4ç”»é¢ï¼‰ | 2-3æ—¥ |
| migrationService å®Ÿè£… | 1-2æ—¥ |
| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ»Stripe ç­‰ï¼‰ | 1-2æ—¥ |
| æ¤œè¨¼ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œç¢ºèª + RLS å‹•ä½œç¢ºèªï¼‰ | 1-2æ—¥ |

### åˆè¨ˆ: 16-28æ—¥

---

## 9. å®Ÿè£…é †åº

```
Phase 1 (Magic Link èªè¨¼)
  â”‚
  â”œâ”€â”€ 1. DB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆusers æ‹¡å¼µï¼‰
  â”œâ”€â”€ 2. magic_link_tokens / app_sessions ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
  â”œâ”€â”€ 3. emailService å®Ÿè£…
  â”œâ”€â”€ 4. sessionService å®Ÿè£…
  â”œâ”€â”€ 5. Magic Link é€ä¿¡/æ¤œè¨¼ API
  â”œâ”€â”€ 6. authMiddleware äºŒé‡å¯¾å¿œ
  â””â”€â”€ 7. ãƒ­ã‚°ã‚¤ãƒ³ UI
  â”‚
Phase 1.5 (LINEâ†’Email ç§»è¡Œ)
  â”‚
  â”œâ”€â”€ 8. migration_tokens ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
  â”œâ”€â”€ 9. migrate_user_data RPC å®Ÿè£…
  â”œâ”€â”€ 10. migrationService å®Ÿè£…
  â”œâ”€â”€ 11. ç§»è¡Œ APIï¼ˆinitiate / verify / execute / statusï¼‰
  â”œâ”€â”€ 12. ç§»è¡Œ UIï¼ˆ4ç”»é¢ï¼‰
  â”œâ”€â”€ 13. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œ
  â””â”€â”€ 14. çµ±åˆæ¤œè¨¼
```
