name: Vercel Stats Weekly Report

on:
  schedule:
    # 毎週月曜日の午前9時（JST）に実行
    # UTC時間で毎週日曜日の午後11時（23:00 UTC = 09:00 JST）
    - cron: '0 23 * * 0'
  workflow_dispatch: # 手動実行も可能にする

jobs:
  vercel-stats:
    name: Collect Vercel Statistics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create .env.local file
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          cat > .env.local << EOF
          VERCEL_TOKEN=${VERCEL_TOKEN}
          VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID}
          VERCEL_TEAM_ID=${VERCEL_TEAM_ID}
          EOF

      - name: Run Vercel stats
        id: vercel-stats
        run: |
          set +e
          OUTPUT=$(npm run vercel:stats 2>&1)
          EXIT_CODE=$?
          set -e
          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          # 出力をファイルにも保存（デバッグ用）
          echo "$OUTPUT" > vercel-stats-output.txt
        continue-on-error: true

      - name: Send webhook notification
        if: always()
        run: |
          # デバッグ: ファイルの存在確認
          if [ ! -f vercel-stats-output.txt ]; then
            echo "Warning: vercel-stats-output.txt not found, using empty output"
            echo "" > vercel-stats-output.txt
          fi

          # Node.jsでJSONペイロードを作成して送信
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          const http = require('http');
          const { URL } = require('url');

          console.log('Starting webhook notification...');
          console.log('STATUS:', process.env.STATUS);
          console.log('Repository:', process.env.GITHUB_REPOSITORY);
          console.log('Run ID:', process.env.GITHUB_RUN_ID);

          let output = '';
          try {
            output = fs.readFileSync('vercel-stats-output.txt', 'utf-8');
            console.log('Output file read successfully, length:', output.length);
          } catch (error) {
            console.warn('Failed to read output file:', error.message);
            output = 'Output file not available';
          }

          // Lark（飛書）webhook形式に合わせる
          const statusEmoji = process.env.STATUS === 'success' ? '✅' : '❌';
          const statusText = process.env.STATUS === 'success' ? '成功' : '失敗';
          const workflowUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

          // メッセージ本文を作成
          const messageText = `【Vercel ダッシュボード統計レポート】\n` +
            `ステータス: ${statusEmoji} ${statusText}\n` +
            `詳細: ${workflowUrl}\n\n` +
            `【統計情報】\n\`\`\`\n${output}\n\`\`\``;

          const payload = {
            msg_type: 'text',
            content: {
              text: messageText
            }
          };

          const webhookUrl = process.env.VERCEL_STATS_WEBHOOK_URL;
          if (!webhookUrl) {
            console.error('ERROR: VERCEL_STATS_WEBHOOK_URL is not set');
            process.exit(1);
          }

          console.log('Webhook URL:', webhookUrl.replace(/\/\/.*@/, '//***@')); // URLをマスク

          let url;
          try {
            url = new URL(webhookUrl);
          } catch (error) {
            console.error('ERROR: Invalid webhook URL:', error.message);
            process.exit(1);
          }

          const client = url.protocol === 'https:' ? https : http;
          const postData = JSON.stringify(payload);

          console.log('Payload size:', postData.length, 'bytes');

          const options = {
            hostname: url.hostname,
            port: url.port || (url.protocol === 'https:' ? 443 : 80),
            path: url.pathname + url.search,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(postData),
            },
            timeout: 30000, // 30秒のタイムアウト
          };

          const req = client.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => { data += chunk; });
            res.on('end', () => {
              console.log('Response status:', res.statusCode);
              console.log('Response headers:', JSON.stringify(res.headers));
              if (res.statusCode >= 200 && res.statusCode < 300) {
                console.log('✅ Webhook notification sent successfully');
                console.log('Response body:', data.substring(0, 500)); // 最初の500文字のみ
                process.exit(0);
              } else {
                console.error(`❌ Webhook notification failed with status ${res.statusCode}`);
                console.error('Response body:', data);
                process.exit(1);
              }
            });
          });

          req.on('error', (error) => {
            console.error('❌ Webhook notification error:', error.message);
            console.error('Error code:', error.code);
            process.exit(1);
          });

          req.on('timeout', () => {
            console.error('❌ Webhook request timeout');
            req.destroy();
            process.exit(1);
          });

          console.log('Sending webhook request...');
          req.write(postData);
          req.end();
          EOF

        env:
          STATUS: ${{ steps.vercel-stats.outputs.exit_code == '0' && 'success' || 'failure' }}
          VERCEL_STATS_WEBHOOK_URL: ${{ secrets.VERCEL_STATS_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
