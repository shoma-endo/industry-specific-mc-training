name: CI

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: npm run build
        env:
          # クライアント環境変数（ビルド時に必須）
          NEXT_PUBLIC_LIFF_ID: dummy-liff-id
          NEXT_PUBLIC_LIFF_CHANNEL_ID: dummy-channel-id
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-anon-key
          NEXT_PUBLIC_SITE_URL: http://localhost:3000
          NEXT_PUBLIC_STRIPE_ENABLED: false
          # サーバー環境変数（ビルド時に必須）
          SUPABASE_SERVICE_ROLE: dummy-service-role
          STRIPE_ENABLED: false
          STRIPE_SECRET_KEY: sk_test_dummy
          STRIPE_PRICE_ID: price_dummy
          OPENAI_API_KEY: sk-dummy
          ANTHROPIC_API_KEY: sk-ant-dummy
          LINE_CHANNEL_ID: dummy-line-channel-id
          LINE_CHANNEL_SECRET: dummy-line-channel-secret

      - name: Send webhook notification
        if: always()
        run: |
          # Node.jsでJSONペイロードを作成して送信
          node << 'EOF'
          const https = require('https');
          const http = require('http');
          const { URL } = require('url');

          // Lark（飛書）webhook形式に合わせる
          const statusEmoji = process.env.STATUS === 'success' ? '✅' : '❌';
          const statusText = process.env.STATUS === 'success' ? '成功' : '失敗';
          const executionType = process.env.GITHUB_EVENT_NAME === 'workflow_dispatch' ? '手動' : '自動';
          const actor = process.env.GITHUB_ACTOR || '不明';
          const branch = process.env.GITHUB_REF_NAME || '不明';

          // メッセージ本文を作成
          const messageText = `【CI ビルド結果】\n${statusEmoji} ${statusText}\n実行: ${executionType}\nユーザー: ${actor}\nブランチ: ${branch}`;

          const payload = {
            msg_type: 'text',
            content: {
              text: messageText
            }
          };

          const webhookUrl = process.env.CI_WEBHOOK_URL;
          if (!webhookUrl) {
            console.error('ERROR: CI_WEBHOOK_URL is not set');
            process.exit(1);
          }

          console.log('Webhook URL:', webhookUrl.replace(/\/\/.*@/, '//***@')); // URLをマスク

          let url;
          try {
            url = new URL(webhookUrl);
          } catch (error) {
            console.error('ERROR: Invalid webhook URL:', error.message);
            process.exit(1);
          }

          const client = url.protocol === 'https:' ? https : http;
          const postData = JSON.stringify(payload);

          console.log('Payload size:', postData.length, 'bytes');

          const options = {
            hostname: url.hostname,
            port: url.port || (url.protocol === 'https:' ? 443 : 80),
            path: url.pathname + url.search,
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(postData)
            },
            timeout: 30000 // 30秒のタイムアウト
          };

          const req = client.request(options, (res) => {
            let data = '';
            res.on('data', (chunk) => { data += chunk; });
            res.on('end', () => {
              console.log('Response status:', res.statusCode);
              console.log('Response headers:', JSON.stringify(res.headers));
              if (res.statusCode >= 200 && res.statusCode < 300) {
                console.log('✅ Webhook notification sent successfully');
                console.log('Response body:', data.substring(0, 500)); // 最初の500文字のみ
                process.exit(0);
              } else {
                console.error(`❌ Webhook notification failed with status ${res.statusCode}`);
                console.error('Response body:', data);
                process.exit(1);
              }
            });
          });

          req.on('error', (error) => {
            console.error('❌ Webhook notification error:', error.message);
            console.error('Error code:', error.code);
            process.exit(1);
          });

          req.on('timeout', () => {
            console.error('❌ Webhook request timeout');
            req.destroy();
            process.exit(1);
          });

          console.log('Sending webhook request...');
          req.write(postData);
          req.end();
          EOF

        env:
          STATUS: ${{ steps.build.outcome == 'success' && 'success' || 'failure' }}
          CI_WEBHOOK_URL: ${{ secrets.CI_WEBHOOK_URL }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
