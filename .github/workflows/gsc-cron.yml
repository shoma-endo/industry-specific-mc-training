name: GSC Evaluate Cron

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  run-gsc-evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Call GSC evaluate endpoint
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          TARGET_URL: https://industry-specific-mc-training.vercel.app/api/cron/gsc-evaluate
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "CRON_SECRET is not set" >&2
            exit 1
          fi
          if [ -z "$TARGET_URL" ]; then
            echo "TARGET_URL is not set" >&2
            exit 1
          fi

          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -X GET "$TARGET_URL" \
              -H "Authorization: Bearer $CRON_SECRET" \
              -H "Accept: application/json" \
              --max-time 310 \
              --output /tmp/response.json \
              --write-out "%{http_code}" \
              --silent)
            CURL_EXIT_CODE=$?

            if [ $CURL_EXIT_CODE -eq 0 ] && [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "Success (HTTP $HTTP_CODE)"
              cat /tmp/response.json
              exit 0
            elif [ $CURL_EXIT_CODE -eq 28 ] || [ "$HTTP_CODE" -eq 503 ] || [ "$HTTP_CODE" -eq 504 ]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((2 ** RETRY_COUNT * 2))
                if [ $CURL_EXIT_CODE -eq 28 ]; then
                  echo "Request timeout. Retrying in ${WAIT_TIME}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                else
                  echo "HTTP $HTTP_CODE received. Retrying in ${WAIT_TIME}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                fi
                sleep $WAIT_TIME
              else
                echo "Max retries reached (curl exit: $CURL_EXIT_CODE, HTTP: $HTTP_CODE)." >&2
                cat /tmp/response.json >&2 2>/dev/null || true
                exit 1
              fi
            else
              echo "HTTP $HTTP_CODE received (curl exit: $CURL_EXIT_CODE)." >&2
              cat /tmp/response.json >&2 2>/dev/null || true
              exit 1
            fi
          done
