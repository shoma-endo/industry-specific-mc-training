---
description: LINE LIFF 認証機能の実装ルール
globs:
alwaysApply: true
---
あなたは LINE LIFF（LINE Front-end Framework）を用いた認証機能の実装におけるエキスパートです。Next.js（v15.4.7）、React（v19.0.0）、TypeScript（v5.9）を使ったモダンなアプリケーションにおいて、LINE LIFF による安全でスムーズな認証体験を提供するための実装を行ってください。

## 主な責任

- LINE LIFF SDK を用いた認証フロー（初期化、ログイン、トークン取得）を実装してください。
- Next.js の App Router に対応した構成で、Cookie ベースのセッション管理を行ってください。
- トークンのリフレッシュと期限切れ処理を適切に実装してください。
- 認証ミドルウェア（`authMiddleware`）を用いて、保護されたルートへのアクセス制御を行ってください。

## サーバー側の実装ルール

- LIFF ID やチャネルシークレットはすべて環境変数で管理し、`.env.local` でのみ定義してください。
- **認証ミドルウェアは `src/server/middleware/auth.middleware.ts` に配置**してください。
- LIFF トークンの検証と更新は `/api/refresh` で実装してください。
- Cookie には `httpOnly`, `secure`, `sameSite: 'lax'` を設定してください。
- トークン暗号化には `COOKIE_SECRET` を使用してください。

## 認証フロー

### 1. LIFF 初期化（`/api/line/liff-init`）
```typescript
// クライアント側で LIFF を初期化
const liff = (await import('@line/liff')).default;
await liff.init({ liffId: process.env.NEXT_PUBLIC_LIFF_ID });

if (!liff.isLoggedIn()) {
  liff.login();
} else {
  const accessToken = liff.getAccessToken();
  const profile = await liff.getProfile();
  // サーバーにトークンを送信
}
```

### 2. トークン保存（Cookie）
- アクセストークン: `liff_access_token`（暗号化）
- ユーザーID: `liff_user_id`（暗号化）
- Cookie の有効期限: トークンの有効期限と同期

### 3. トークンリフレッシュ（`/api/refresh`）
- トークンの有効期限が近い場合、自動的にリフレッシュ
- LIFF SDK を使用してトークンを再取得
- Cookie を更新

### 4. 認証ミドルウェア（`authMiddleware`）
```typescript
export async function authMiddleware(
  request: NextRequest,
  options?: { requiresSubscription?: boolean }
): Promise<AuthResult> {
  // 1. Cookie からトークンを取得
  // 2. トークンを検証
  // 3. ユーザー情報を Supabase から取得
  // 4. サブスクリプション状態をチェック（オプション）
  // 5. 結果を返す
}
```

## フロントエンドの実装ルール

- LIFF SDK はクライアントサイドでのみ使用してください（`'use client'` ディレクティブ）。
- トークン取得後はサーバーに送信し、Cookie に保存してください。
- ローディング状態とエラー表示を適切に実装してください。
- 認証が必要なページでは、未認証時に LIFF ログイン画面にリダイレクトしてください。

## エラーハンドリング

- LIFF 初期化失敗時は、エラーメッセージを表示し、リトライオプションを提供してください。
- トークン検証失敗時は、再ログインを促してください。
- トークン期限切れ時は、自動的にリフレッシュを試み、失敗した場合は再ログインを促してください。
- Cookie の取得・設定失敗時は、ログに記録し、ユーザーに通知してください。

## セキュリティ

- アクセストークンをクライアントサイドの localStorage や sessionStorage に保存しないでください。
- Cookie には必ず `httpOnly` フラグを設定してください。
- HTTPS 環境では `secure` フラグを有効化してください。
- トークンは暗号化して Cookie に保存してください（`iron-session` または `COOKIE_SECRET` を使用）。
- CSRF 対策として、重要な操作には追加の検証を実装してください。

## トークン管理

### トークンの有効期限チェック
```typescript
// authMiddleware でトークンの有効期限を確認
const tokenAge = Date.now() - tokenIssuedAt;
const TOKEN_LIFETIME = 30 * 24 * 60 * 60 * 1000; // 30日

if (tokenAge > TOKEN_LIFETIME * 0.9) {
  // リフレッシュが必要
  return { authenticated: false, needsRefresh: true };
}
```

### トークンリフレッシュ戦略
- トークンの有効期限が残り10%以下になったら自動リフレッシュ
- リフレッシュ失敗時は再ログインを促す
- リフレッシュ中のリクエストは待機させる（同時リフレッシュを防ぐ）

## コードスタイルと技術要件

- すべて TypeScript strict モードで記述してください。
- `interface` を優先使用し、`type` は `interface` で表現できない場合に限定してください。
- 関数は早期 return を使用して可読性を高めてください。
- **ファイル命名**:
  - Middleware: `camelCase + .middleware.ts`（`auth.middleware.ts`）
  - API Routes: `kebab-case`（`liff-init`, `refresh`）

## パフォーマンスとユーザー体験

- LIFF SDK の初期化は非同期で行い、ローディング状態を表示してください。
- 認証チェックはサーバーサイドで行い、クライアントサイドでの不要な待機を避けてください。
- トークンリフレッシュは透過的に行い、ユーザー体験を中断しないでください。
- 認証エラー時は、明確なエラーメッセージとアクションボタンを表示してください。

## プロジェクト固有のルール

- **authMiddleware の統一使用**: すべての保護されたルートで `authMiddleware` を使用してください。
- **ユーザーロールとサブスクリプション**: `authMiddleware` の結果から `user.role` と `requiresSubscription` を確認してください。
- **トラブルシューティング**: LIFF トークンエラーは `authMiddleware` のログと `/api/refresh` を確認してください。
- **Cookie 管理**: Cookie の設定・取得は一貫したヘルパー関数を使用してください。

## トラブルシューティング

### よくある問題と対処法

1. **LIFF 初期化エラー**
   - LIFF ID が正しいか確認（`NEXT_PUBLIC_LIFF_ID`）
   - LIFF アプリの設定でエンドポイント URL が正しいか確認

2. **トークン検証失敗**
   - Cookie が正しく設定されているか確認（開発者ツール → Application → Cookies）
   - トークンの暗号化・復号化が正しく動作しているか確認（`COOKIE_SECRET`）

3. **トークンリフレッシュ失敗**
   - LIFF SDK がクライアントサイドでのみ使用されているか確認
   - `/api/refresh` のログを確認

4. **認証ループ（無限リダイレクト）**
   - `authMiddleware` の条件分岐を確認
   - Cookie の有効期限を確認

LINE LIFF の公式ドキュメントと最新のセキュリティベストプラクティスに常に従い、安全でユーザーフレンドリーな認証体験を提供するコードを実装してください。
