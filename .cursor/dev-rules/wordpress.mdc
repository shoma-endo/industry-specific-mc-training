---
description: WordPress 連携機能の実装ルール
globs:
alwaysApply: true
---
あなたは WordPress 連携機能（WordPress.com / Self-hosted 両対応）の実装におけるエキスパートです。Next.js（v15.4.7）、React（v19.0.0）、TypeScript（v5.9）を使ったモダンなアプリケーションにおいて、WordPress REST API との安全で堅牢な連携を提供するための実装を行ってください。

## 主な責任

- WordPress.com と Self-hosted WordPress の両方に対応した REST API 連携を実装してください。
- OAuth 2.0 トークン管理（WordPress.com）と Basic 認証（Self-hosted）の両方をサポートしてください。
- Next.js の App Router に対応した構成で、Server Actions を活用し、機密データの安全な処理を行ってください。
- 記事取得、投稿管理、メディアアップロードなどの WordPress 操作を型安全に実装してください。

## サーバー側の実装ルール

- WordPress API の認証情報はすべて環境変数で管理し、`.env.local` でのみ定義してください。
- **すべての WordPress 操作は `src/server/services/wordpressService.ts` 経由に統一**してください。
- Server Action は `src/server/actions/wordpress.actions.ts` に配置してください。
- OAuth トークンは Cookie で管理し、`COOKIE_SECRET` で暗号化してください。
- REST API エンドポイントは複数候補を試行し、最初に成功したものを使用するパターンを踏襲してください。

## WordPress.com と Self-hosted の対応

### WordPress.com（OAuth 2.0）
- OAuth フローは `/api/wordpress/oauth-init` と `/api/wordpress/oauth-callback` で実装
- アクセストークンを Cookie に保存（`wordpress_access_token`）
- REST API エンドポイント: `https://public-api.wordpress.com/rest/v1.1/`
- 環境変数: `WORDPRESS_COM_CLIENT_ID`, `WORDPRESS_COM_CLIENT_SECRET`, `WORDPRESS_COM_REDIRECT_URI`

### Self-hosted WordPress（Basic 認証または Application Password）
- サイト URL を環境変数で管理: `WORDPRESS_SITE_URL`
- Application Password を使用: `WORDPRESS_USERNAME`, `WORDPRESS_APP_PASSWORD`
- REST API エンドポイント: `{SITE_URL}/wp-json/wp/v2/`
- Basic 認証ヘッダーを設定

## REST API パターン

### 複数候補エンドポイントの試行
```typescript
const candidates = [
  `https://public-api.wordpress.com/rest/v1.1/sites/${siteId}/posts`,
  `${siteUrl}/wp-json/wp/v2/posts`,
];

for (const endpoint of candidates) {
  try {
    const response = await fetch(endpoint, config);
    if (response.ok) return await response.json();
  } catch (error) {
    continue; // 次の候補を試行
  }
}
```

### URL 正規化
- サイト URL は末尾のスラッシュを除去
- プロトコル（https://）の有無を統一
- WordPress.com のサイト識別子（ドメインまたは数値ID）に対応

## エラーハンドリング

- REST API のエラーレスポンスを適切にパースし、ユーザーにわかりやすいメッセージを返してください。
- 認証エラー（401）、権限エラー（403）、サーバーエラー（500）を区別して処理してください。
- トークン期限切れの場合は、再認証を促すメッセージを表示してください。
- 返却型は `{ success: boolean, error?: string, data?: T }` の形式で統一してください。

## セキュリティ

- OAuth トークンや Application Password をクライアントに露出しないでください。
- Cookie には `httpOnly`, `secure`, `sameSite: 'lax'` を設定してください。
- CSRF 対策として、OAuth の state パラメータを検証してください。
- WordPress API へのリクエストは Server Actions または API Routes 経由のみで行ってください。

## データ取得と型定義

- WordPress REST API のレスポンス構造は型で明示してください（`src/types/wordpress.ts`）。
- 記事データ（`title`, `content`, `excerpt`, `featured_media` など）を適切に型定義してください。
- メディアデータ（画像URL、alt テキスト）を型安全に扱ってください。
- カスタムフィールドやメタデータにアクセスする場合は、型を拡張してください。

## コードスタイルと技術要件

- すべて TypeScript strict モードで記述してください。
- `interface` を優先使用し、`type` は `interface` で表現できない場合に限定してください。
- 関数は早期 return を使用して可読性を高めてください。
- **ファイル命名**:
  - Services: `camelCase + Service.ts`（`wordpressService.ts`）
  - Actions: `camelCase + .actions.ts`（`wordpress.actions.ts`）
  - Types: `kebab-case.ts`（`wordpress.ts`）

## パフォーマンスとユーザー体験

- 記事一覧取得時はページネーションを実装し、一度に大量のデータを取得しないでください。
- 画像URLは WordPress のメディアエンドポイントから取得し、適切なサイズを選択してください。
- データ取得中はローディング状態を表示してください。
- エラー発生時は具体的なエラーメッセージとリトライオプションを提供してください。

## プロジェクト固有のルール

- **WordPressService の統一**: すべての WordPress 操作は `wordpressService` を経由してください。
- **OAuth と Basic 認証の併用**: ユーザーが選択できるように両方の認証方式をサポートしてください。
- **既存記事の取り込み**: `/app/analytics` からの記事取得と `AnnotationPanel` での表示に対応してください。
- **URL 正規化**: WordPress サイト URL の入力時は自動的に正規化してください。

WordPress REST API の公式ドキュメントと最新ベストプラクティスに常に従い、安全で信頼性の高い WordPress 連携を提供するコードを実装してください。
