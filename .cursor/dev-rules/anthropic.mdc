---
description: Anthropic Claude API 統合の実装ルール
globs:
alwaysApply: true
---
あなたは Anthropic Claude API を用いた AI 機能の実装におけるエキスパートです。Next.js（v15.4.7）、React（v19.0.0）、TypeScript（v5.9）を使ったモダンなアプリケーションにおいて、Claude API によるチャット、コンテンツ生成、選択編集などの AI 機能を安全かつ効率的に提供するための実装を行ってください。

## 主な責任

- Anthropic Claude API（Sonnet 4.5）を用いたチャット機能を実装してください。
- Server-Sent Events（SSE）によるストリーミングレスポンスを実装してください。
- Tool Use（Function Calling）を活用した選択編集機能を実装してください。
- Prompt Caching を活用してコストとレイテンシを最適化してください。

## サーバー側の実装ルール

- Anthropic API キーはすべて環境変数で管理し、`.env.local` でのみ定義してください（`ANTHROPIC_API_KEY`）。
- **すべての Claude API 操作は `src/server/services/llmService.ts` 経由に統一**してください。
- API Routes は `/api/chat/anthropic` と `/api/chat/canvas/stream` に配置してください。
- モデル設定は `src/lib/constants.ts` の `MODEL_CONFIGS` で一元管理してください。
- プロンプトテンプレートは `src/lib/prompts.ts` で管理してください。

## SSE（Server-Sent Events）実装パターン

### 基本的な SSE レスポンス
```typescript
const encoder = new TextEncoder();
const stream = new ReadableStream({
  async start(controller) {
    try {
      // Claude API にストリーミングリクエスト
      const response = await anthropic.messages.stream({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 8192,
        messages: messages,
      });

      // イベントをクライアントに送信
      for await (const event of response) {
        if (event.type === 'content_block_delta') {
          const data = JSON.stringify({ type: 'content', content: event.delta.text });
          controller.enqueue(encoder.encode(`data: ${data}\n\n`));
        }
      }

      // 完了シグナル
      controller.enqueue(encoder.encode('data: [DONE]\n\n'));
      controller.close();
    } catch (error) {
      // エラーハンドリング
      const errorData = JSON.stringify({ type: 'error', error: error.message });
      controller.enqueue(encoder.encode(`data: ${errorData}\n\n`));
      controller.close();
    }
  }
});

return new Response(stream, {
  headers: {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
  },
});
```

### Ping と Timeout 管理
- Ping 間隔: 20秒（`sendPing` 関数）
- Idle Timeout: 5分（300秒）
- クライアント側でタイムアウトを検出し、再接続を試みる

## Tool Use（選択編集）実装パターン

### Canvas 選択編集
```typescript
const tools = [
  {
    name: 'replace_content',
    description: '選択されたテキストを新しい内容で置き換えます',
    input_schema: {
      type: 'object',
      properties: {
        new_content: {
          type: 'string',
          description: '置き換え後の新しい内容',
        },
      },
      required: ['new_content'],
    },
  },
];

const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-5-20250929',
  max_tokens: 8192,
  tools: tools,
  messages: [
    {
      role: 'user',
      content: `以下のテキストを${instruction}してください：\n\n${selectedText}`,
    },
  ],
});

// Tool Use の結果を抽出
const toolUse = response.content.find((block) => block.type === 'tool_use');
if (toolUse && toolUse.name === 'replace_content') {
  const newContent = toolUse.input.new_content;
  // クライアントに返す
}
```

## モデル設定とコスト最適化

### MODEL_CONFIGS の活用
```typescript
export const MODEL_CONFIGS = {
  'claude-sonnet-4-5': {
    id: 'claude-sonnet-4-5-20250929',
    maxTokens: 8192,
    contextWindow: 200000,
    useCases: ['chat', 'analysis', 'generation'],
  },
  'claude-haiku-4': {
    id: 'claude-haiku-4-20250514',
    maxTokens: 4096,
    contextWindow: 200000,
    useCases: ['simple-tasks', 'quick-responses'],
  },
};
```

### Prompt Caching の活用
- システムプロンプトや長いコンテキストには `cache_control` を設定
- キャッシュブレイクポイントを適切に配置
- キャッシュヒット率をモニタリング

```typescript
const messages = [
  {
    role: 'user',
    content: [
      {
        type: 'text',
        text: systemPrompt,
        cache_control: { type: 'ephemeral' },
      },
      {
        type: 'text',
        text: userMessage,
      },
    ],
  },
];
```

## エラーハンドリング

- API エラー（401, 429, 500）を適切にハンドリングしてください。
- レート制限エラー時は、リトライロジックを実装してください（Exponential Backoff）。
- トークン制限超過時は、ユーザーに明確なエラーメッセージを表示してください。
- ストリーミング中のエラーは SSE で `type: 'error'` として送信してください。

## セキュリティ

- API キーをクライアントに露出しないでください。
- すべての Claude API 呼び出しはサーバーサイド（API Routes または Server Actions）で行ってください。
- ユーザー入力を適切にサニタイズし、プロンプトインジェクション攻撃を防いでください。
- 生成されたコンテンツは XSS 対策として適切にエスケープしてください。

## プロンプトエンジニアリング

### システムプロンプトの構造
```typescript
export const SYSTEM_PROMPTS = {
  chat: `あなたは業界特化のマーケティングコンテンツ作成を支援するAIアシスタントです。

  # 役割
  - ユーザーのビジネス情報を理解し、適切な提案を行う
  - 広告文、LP、ブログ記事などのコンテンツを生成する

  # 制約
  - 日本語で回答する
  - 具体的で実用的な提案を行う
  - ユーザーの業界に合わせた専門用語を使用する`,

  blog: `あなたはSEOに最適化されたブログ記事を作成するエキスパートです。

  # 出力形式
  - タイトル（H1）
  - リード文（導入）
  - 本文（見出しと段落）
  - まとめ

  # SEO要件
  - キーワードを適切に配置
  - 読みやすい構造
  - E-E-A-T を意識`,
};
```

### 変数注入パターン
- ビジネス情報（5W2H）を動的に注入
- 注釈（`content_annotations`）をプロンプトに含める
- ステップごとのカスタマイズ（`BLOG_STEP_IDS`）

## コードスタイルと技術要件

- すべて TypeScript strict モードで記述してください。
- `interface` を優先使用し、`type` は `interface` で表現できない場合に限定してください。
- 関数は早期 return を使用して可読性を高めてください。
- **ファイル命名**:
  - Services: `camelCase + Service.ts`（`llmService.ts`）
  - API Routes: `kebab-case`（`anthropic`, `canvas`）
  - Constants: `kebab-case.ts`（`constants.ts`, `prompts.ts`）

## パフォーマンスとユーザー体験

- ストリーミングレスポンスを活用し、逐次的にコンテンツを表示してください。
- ローディング状態を適切に表示し、待ち時間を体感させないでください。
- エラー時はリトライオプションを提供してください。
- 生成速度が遅い場合は、モデルを Haiku に切り替えるオプションを提供してください。

## プロジェクト固有のルール

- **LLMService の統一**: すべての Claude API 操作は `llmService` を経由してください。
- **モデル切り替え**: `MODEL_CONFIGS` を参照し、用途に応じてモデルを選択してください。
- **ステップ管理**: ブログ生成の各ステップ（`BLOG_STEP_IDS`）に応じたプロンプトを使用してください。
- **コスト監視**: `npx ccusage@latest` でコストを定期的に確認してください。

## トラブルシューティング

### よくある問題と対処法

1. **SSE が途切れる**
   - Ping 間隔（20秒）を確認
   - Idle Timeout（5分）を確認
   - `sendPing` 実装を確認

2. **トークン制限エラー**
   - `max_tokens` の設定を確認
   - コンテキストウィンドウの使用状況を確認
   - 長いメッセージを分割する

3. **レート制限エラー（429）**
   - Exponential Backoff でリトライ
   - リクエスト頻度を調整

4. **Tool Use が正しく動作しない**
   - Tool の定義（`input_schema`）を確認
   - Tool Use の結果パースロジックを確認

Anthropic Claude API の公式ドキュメントと最新のベストプラクティスに常に従い、高品質で効率的な AI 機能を提供するコードを実装してください。
