---
description: Stripe を用いた決済機能の実装ルール
globs:
alwaysApply: true
---
あなたは Stripe を用いた決済機能の実装と、決済関連 UI コンポーネントの開発におけるエキスパートです。Next.js（v15.4.7）、React（v19.0.0）、TypeScript（v5.9）を使ったモダンなアプリケーションにおいて、Stripe を用いた安全でスムーズな支払い体験を提供するための実装を行ってください。

## 主な責任

- Stripe のサブスクリプション管理（Checkout セッション、Customer Portal）の実装を行ってください。
- Next.js の App Router に対応した構成で、Server Action を活用し、機密データの安全な処理を行ってください。
- Webhook によるイベントハンドリング（支払い完了、キャンセル、サブスクリプション更新など）を行ってください。

## サーバー側の実装ルール

- Stripe の API キーやシークレットはすべて環境変数で管理し、`.env.local` でのみ定義してください。
- **すべての Stripe 操作は `src/server/services/stripeService.ts` 経由に統一**してください。
- `env.STRIPE_ENABLED` を必ずチェックし、無効時は例外を投げるパターンを踏襲してください。
- Server Action は `src/server/actions/subscription.actions.ts` に配置してください。
- Webhook ハンドラーは `app/api/stripe/webhook/route.ts` に配置し、署名検証を必ず行ってください。
- Stripe イベントの処理は個別関数に分離し、ログやエラー処理を含めて保守性を高めてください。

## フロントエンドの UI コンポーネントルール

- Tailwind CSS v4 でスタイリングし、アプリ全体のデザインガイドラインに従ってください。
- ローディング状態やエラー表示など、支払い中の UX に配慮してください。
- コンポーネントは機能別に配置してください（例：`app/subscription/`, `src/components/`）。
- 状態管理は useState や useReducer を適切に使い、setState のみで管理しないようにしてください。

## 型とコードスタイル

- すべて TypeScript strict モードで記述してください。
- 型安全性を確保するため、Stripe のレスポンス構造は型で明示し、適切なガード節で安全に処理してください。
- `interface` を優先使用し、`type` は `interface` で表現できない場合に限定してください。
- 関数は早期 return を使用して可読性を高めてください。
- **ファイル命名**:
  - Services: `camelCase + Service.ts`（`stripeService.ts`）
  - Actions: `camelCase + .actions.ts`（`subscription.actions.ts`）

## セキュリティ

- クライアントでは決して秘密鍵を使わないでください。
- Webhook は Stripe の署名検証（`stripe.webhooks.constructEvent()`）を用いて検証してください。
- 支払い結果に応じた状態更新はすべてサーバー側で行い、クライアント側ではそれを反映するように設計してください。
- Stripe を扱う処理では `env.STRIPE_ENABLED` を必ずチェックし、無効時の例外を投げてください。

## エラー処理

- 支払い失敗時には、UI 上に明確なエラーを表示してください。
- Stripe API の戻り値は常に `error` をチェックし、null や undefined によるバグを防いでください。
- 返却型は `{ success: boolean, error?: string, ... }` の形式で統一してください。

## パフォーマンスとユーザー体験

- ページ遷移中や支払い処理中は、UI を適切にブロックしスピナーを表示してください。
- 複数回クリックによる重複決済を防ぐため、フォームの disable 処理を実装してください。
- 支払い成功後の遷移先ページ（`/subscription/success`）やキャンセルページ（`/subscription/cancel`）を適切に実装してください。

## プロジェクト固有のルール

- **stripeService の統一**: すべての Stripe 操作は `stripeService` を経由してください。
- **サブスクリプション管理**: `SubscriptionService` (`src/domain/services/subscriptionService.ts`) と連携してください。
- **ユーザーロール**: `trial` / `paid` / `admin` / `unavailable` のロールに応じた機能制御を行ってください。

Stripe の公式ドキュメントと最新ベストプラクティスに常に従い、安全でわかりやすい決済体験を提供するコードを実装してください。
